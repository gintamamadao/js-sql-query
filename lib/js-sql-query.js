"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("@babel/runtime/helpers/typeof")),r=require("schema-verify"),n=e(r),i=e(require("regenerator-runtime"));var a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function u(e,t){for(var r=0;t.length>r;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var o=function(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),e};function s(e,t){return e(t={exports:{}},t.exports),t.exports}var c=s((function(e){function r(n){return e.exports=r="function"==typeof Symbol&&"symbol"===t(Symbol.iterator)?function(e){return t(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":t(e)},r(n)}e.exports=r}));var l=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var f=function(e,t){return!t||"object"!==c(t)&&"function"!=typeof t?l(e):t},y=s((function(e){function t(r){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(r)}e.exports=t})),h=s((function(e){function t(r,n){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(r,n)}e.exports=t}));var p=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)};function v(e,t){return e.replace(/\{\{([a-zA-Z_0-9]+)\}\}/g,(function(e,n){return t.hasOwnProperty(n)&&r.Type.string.isNotEmpty(t[n])?t[n]+" ":""})).trim()}function d(e,t){var n=[];return r.Type.array.is(e)?n=e:((t=r.Type.array.safe(t)).unshift(e),n=t),n}var m=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};var g,T,w,k,b=function(e){for(var t=1;arguments.length>t;t++){var r=null!=arguments[t]?Object(arguments[t]):{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter((function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})))),n.forEach((function(t){m(e,t,r[t])}))}return e},E=b({},{errorFuncInfo:"错误的组合函数信息"},{errorFieldDataArr:"错误的字段数据组",errorInsertValues:"错误的插入值"},{errorDialect:"错误的数据库类型",errorManualSql:"错误的自定义sql",errorExecute:"缺少或错误的数据库连接",emptySqlQuery:"缺少sql语句"},{errorPage:"错误的页码",errorSize:"错误的页码",errorStep:"错误的步长",errorOffset:"错误的偏移"},{errorOrderInfo:"错误的排序信息",errorValueList:"需要非空数组"},{errorFieldMap:"错误的字段映射"},{errorTermdata:"错误的条件数据",errorTermSign:"错误的条件类型",errorTermValue:"错误的条件值",errorTermInfo:"错误的条件信息",errorTermBracket:"错误的条件括号信息",errorTermLogic:"错误的条件逻辑"},{emptyUpdateInfo:"缺少更新信息",errorUpdateInfo:"错误的更新信息"},{emptyQueryType:"未选择sql类型"},{errorCreateDbName:"错误的数据库名"},{errorAlterField:"错误的修改配置",emptyAlterInfos:"空的修改配置"},{tableFieldsError:"错误的表字段名",tableFieldsAsMapError:"错误的表字段映射名",joinTableInfoError:"错误的联查信息"},{errorTableName:"错误的表名，需要非空字符串",errorField:"错误的表名，需要非空字符串",errorFields:"错误的字段，需要非空字符串或非空字符串数组",errorFieldData:"错误的字段数据",needStr:"需要字符串",needNumStr:"需要数字或者字符串",notSupportDialect:"无法支持当前类型数据库",errorTermStatus:"未设置条件类型"}),N={mysql:{safeValue:function(e){var t="";if("string"==typeof e&&(e=e.replace(/\'/g,(function(){return"''"})).replace(/\\/g,(function(){return"\\\\"})),t="'".concat(e,"'")),r.Type.number.is(e)&&(t="'".concat(e,"'")),!t)throw new Error(E.needNumStr);return t},safeKey:function(e){if(!r.Type.string.isNotEmpty(e))throw new Error(E.needStr);return"`"+e.replace(/`/g,"``")+"`"}},mssql:{safeValue:function(e){var t="";if("string"==typeof e&&(e=e.replace(/\'/g,(function(){return"''"})),t="'".concat(e,"'")),r.Type.number.is(e)&&(t="'".concat(e,"'")),!t)throw new Error(E.needNumStr);return t},safeKey:function(e){if(!r.Type.string.isNotEmpty(e))throw new Error(E.needStr);return"[".concat(e,"]")}},postgresql:{safeValue:function(e){var t="";if("string"==typeof e&&(e=e.replace(/\'/g,(function(){return"''"})),t="'".concat(e,"'")),r.Type.number.is(e)&&(t="'".concat(e,"'")),!t)throw new Error(E.needNumStr);return t},safeKey:function(e){var t;if(!r.Type.string.isNotEmpty(e))throw new Error(E.needStr);return t=e.replace(/\"/g,'""'),'"'.concat(t,'"')}},sqlite:{safeValue:function(e){var t="";if("string"==typeof e&&(e=e.replace(/\'/g,(function(){return"''"})),t="'".concat(e,"'")),r.Type.number.is(e)&&(t="'".concat(e,"'")),!t)throw new Error(E.needNumStr);return t},safeKey:function(e){if(!r.Type.string.isNotEmpty(e))throw new Error(E.needStr);return"`"+e.replace(/`/g,"``")+"`"}}};!function(e){e.mysql="mysql",e.mssql="mssql",e.postgresql="postgresql",e.sqlite="sqlite"}(g||(g={})),function(e){e.insert="INSERT",e.replace="REPLACE",e.select="SELECT",e.update="UPDATE",e.delete="DELETE",e.create="CREATE",e.alter="ALTER"}(T||(T={})),function(e){e.count="COUNT",e.sum="SUM",e.max="MAX",e.min="MIN",e.avg="AVG",e.abs="ABS",e.ceil="CEIL",e.floor="FLOOR",e.round="ROUND",e.log="LOG",e.log2="LOG2",e.exp="EXP",e.power="POWER",e.acos="ACOS",e.asin="ASIN",e.atan="ATAN",e.cos="COS",e.sin="SIN",e.tan="TAN",e.conv="CONV",e.random="RANDOM",e.rand="RAND",e.radians="RADIANS",e.degrees="DEGREES",e.distinct="DISTINCT"}(w||(w={})),function(e){e.and="AND",e.or="OR"}(k||(k={}));var q,S={and:"AND",or:"OR"};!function(e){e.equal="=",e.notEqual="<>",e.more=">",e.less="<",e.moreEqual=">=",e.lessEqual="<=",e.like="LIKE",e.notlike="NOT LIKE",e.isNot="IS NOT",e.in="IN",e.notIn="NOT IN",e.between="BETWEEN",e.notBetween="NOT BETWEEN"}(q||(q={}));var O,I,C,F,L,j,x,B,A,D={equal:"=",notEqual:"<>",more:">",less:"<",moreEqual:">=",lessEqual:"<=",like:"LIKE",notlike:"NOT LIKE",isNot:"IS NOT",in:"IN",notIn:"NOT IN",between:"BETWEEN",notBetween:"NOT BETWEEN"};!function(e){e.desc="DESC",e.asc="ASC",e.field="FIELD"}(O||(O={})),function(e){e.set="SET",e.add="ADD",e.minus="MINUS"}(I||(I={})),function(e){e.func="FUNC",e.term="TERM",e.order="ORDER"}(C||(C={})),function(e){e.tinyint="TINYINT",e.smallint="SMALLINT",e.mediumint="MEDIUMINT",e.int="INT",e.bigint="BIGINT",e.float="FLOAT",e.double="DOUBLE",e.decimal="DECIMAL",e.date="DATE",e.time="TIME",e.year="YEAR",e.datetime="DATETIME",e.timestamp="TIMESTAMP",e.char="CHAR",e.varchar="VARCHAR",e.tinyblob="TINYBLOB",e.tinytest="TINYTEXT",e.blob="BLOB",e.test="TEXT",e.mediumblob="MEDIUMBLOB",e.mediumtext="MEDIUMTEXT",e.longblob="LONGBLOB",e.longtext="LONGTEXT"}(F||(F={})),function(e){e.primaryKey="PRIMARY KEY",e.uniqueKey="UNIQUE KEY",e.engine="ENGINE",e.autoIncrement="AUTO_INCREMENT",e.defaultCharset="DEFAULT CHARSET",e.comment="COMMENT",e.unsigned="UNSIGNED",e.notNull="NOT NULL",e.default="DEFAULT",e.onUpdate="ON UPDATE",e.constraint="CONSTRAINT"}(L||(L={})),function(e){e.add="ADD",e.drop="DROP",e.modify="MODIFY",e.change="CHANGE"}(j||(j={})),function(e){e.inner="INNER",e.left="LEFT",e.right="RIGHT"}(x||(x={})),function(e){e.where="whereTerm",e.having="havingTerm"}(B||(B={})),function(e){e.mysql="mysql",e.mssql="mssql"}(A||(A={}));var M=new n({type:Array,elements:{type:Object,required:!0,props:[[{type:String},{type:Number}]]}}).verify,K=new n({type:Object,restrict:!0,props:[{index:"funcFeild",required:!0,type:String}]}),U=new n({type:Object,restrict:!0,props:[{type:String,index:"func",required:!0,custom:function(e){return!!w[e]}},[{index:"field",required:!0,type:String},{type:Number}]]}),V=K.verify,R=U.verify,P=new n({type:Object,restrict:!0,props:[{index:"safeKey",required:!0,type:Function},{index:"safeValue",required:!0,type:Function}]}),_=new n([{type:String,minLength:1},{type:Function},{type:Object}]),G=P.verify,H=_.verify,Q=new n({type:Number,integer:!0,min:1}),W=new n({type:Object,restrict:!0,props:[{type:Number,index:"offset",integer:!0,required:!0},{type:Number,index:"step",integer:!0,required:!0}]}),Y=Q.verify,X=W.verify,J=new n({type:Object,restrict:!0,props:[{index:"field",required:!0,type:String},{index:"type",required:!0,type:String,enum:O},{index:"list",type:Array,elements:[[{type:String,required:!0,minLength:1},{type:Number}]]}]}),z=new n({type:Array,elements:[[{type:String,required:!0,minLength:1},{type:Number}]]}),Z=J.verify,$=z.verify,ee=new n({type:Object,props:[[{required:!0,type:String},{type:Number},{type:Array,minLength:1,elements:[[{type:String,required:!0},{type:Number}]]}]]}),te=new n({type:String,enum:Object.keys(D).map((function(e){return D[e]}))}),re=new n({type:String,enum:Object.keys(S).map((function(e){return S[e]}))}),ne=new n([{required:!0,type:String},{type:Number}]),ie=new n({type:Array,minLength:1,elements:[[{type:String,required:!0},{type:Number}]]}),ae=new n({type:Array,length:2,elements:[[{type:String,required:!0},{type:Number}]]}),ue=new n({type:Object,restrict:!0,props:[{index:"position",required:!0,type:Number,min:1},{index:"logic",required:!0,type:String,enum:Object.keys(S).map((function(e){return S[e]}))}]}),oe=new n({type:Object,restrict:!0,props:[{index:"field",required:!0,type:String,minLength:1},[{index:"value",required:!0,type:String},{type:Number},{type:Array,minLength:1,elements:[[{type:String,required:!0},{type:Number}]]}],{index:"sign",required:!0,type:String,enum:Object.keys(D).map((function(e){return D[e]}))},{index:"logic",required:!0,type:String,enum:Object.keys(S).map((function(e){return S[e]}))}]}),se=ee.verify,ce=te.verify,le=re.verify,fe=ne.verify,ye=ie.verify,he=ae.verify,pe=ue.verify,ve=oe.verify,de=new n({type:Object,props:[[{index:"value",required:!0,type:String},{type:Number}],{index:"type",required:!0,type:String,enum:I}]}).verify,me=new n({type:Object,props:[{index:"field",required:!0,type:String,minLength:1},{index:"type",required:!0,type:String,minLength:1},{index:"unsigned",type:Boolean},{index:"autoIncrement",type:Boolean},{index:"notNull",type:Boolean},[{index:"default",type:String},{type:Number}],{index:"onUpdate",type:String},{index:"comment",type:String}]}),ge=new n({type:Object,props:[{index:"keyName",required:!0,type:String,minLength:1},{index:"combineFields",required:!0,type:Array,minLength:1,elements:{type:String,minLength:1}}]}),Te=new n({type:Object,props:[{index:"tableName",required:!0,type:String,minLength:1},[{index:"primaryKey",required:!0,type:String,minLength:1},ge],[{index:"uniqueKey",type:String,minLength:1},ge],{index:"engine",type:String},{index:"defaultCharset",type:String},{index:"comment",type:String},{index:"autoIncrement",type:Number},{index:"fields",type:Array,minLength:1,elements:me}]}).verify,we=new n({type:Object,props:[{index:"field",type:String,minLength:1},{index:"type",type:String,minLength:1},{index:"unsigned",type:Boolean},{index:"autoIncrement",type:Boolean},{index:"notNull",type:Boolean},[{index:"default",type:String},{type:Number}],{index:"onUpdate",type:String},{index:"comment",type:String}]}),ke=new n({type:Object,props:[{index:"method",required:!0,type:String,enum:j},{index:"field",required:!0,type:String,minLength:1},{index:"alterField",required:!0,schema:we}]}).verify,be=new n({type:Object,props:{type:Array,elements:{type:String,required:!0,minLength:1}}}),Ee=new n({type:Object,props:{type:Object,props:{type:String,required:!0,minLength:1}}}),Ne=new n({type:Object,props:{tableName:{type:String,required:!0,minLength:1},termInfos:{type:Array,required:!0,elements:{type:Object,props:{symbol:{type:String,required:!0,minLength:1,enum:Object.keys(D).map((function(e){return D[e]}))},tableFields:{type:Object,props:{type:String,required:!0,minLength:1}}}}}}}),qe=be.verify,Se=Ee.verify,Oe=Ne.verify,Ie=new n({type:Array,elements:{type:String,required:!0,minLength:1}}).verify,Ce=new n({type:Object,props:{type:String,required:!0,minLength:1}}).verify,Fe=new n({type:Number,natural:!0}).verify,Le=new n({type:Number,integer:!0}).verify,je=new n({type:Object,props:[[{required:!0,type:String},{type:Number}]]}).verify,xe=[],Be=new(function(){function e(){a(this,e)}return o(e,[{key:"getStore",value:function(){return xe.slice()}},{key:"storeSql",value:function(e){r.Type.string.isNotEmpty(e)&&xe.push(e)}},{key:"isStoreEmpty",value:function(){return!(xe.length>0)}},{key:"cleanStoreSql",value:function(){xe=[]}}]),e}()),Ae=function(){function e(){a(this,e),this._queryTable="",this._dialect={},this._dialectType="",this._execute={},this._safeValue=function(){return""},this._safeKey=function(){return""},this.safeValue=function(e){switch(this._dialectType){case g.mysql:e=this.loadModule(A.mysql).escape(e);break;default:e=this._safeValue(e)}return e+""},this.safeKey=function(e){return this._safeKey(e)}}return o(e,[{key:"setDialect",value:function(e){if(!G(N[e]))throw new Error(E.errorDialect);var t=N[e];this._dialect=t,this._dialectType=e,this._safeValue=t.safeValue,this._safeKey=t.safeKey}},{key:"loadModule",value:function(e){try{return require(e)}catch(t){if(t&&"MODULE_NOT_FOUND"===t.code)throw new Error("请先安装模块 ".concat(e));throw t}}},{key:"manualSql",value:function(t,r){if(!(H(t)||t instanceof e))throw new Error(E.errorManualSql);this[r]=t}},{key:"formatManualSql",value:function(t){var n=this[t];return r.Type.string.is(n)||r.Type.func.is(n)&&(n=n(),r.Type.string.is(n))||r.Type.object.isNotEmpty(n)&&n instanceof e&&r.Type.string.is(n=n.query)?n:""}},{key:"build",value:function(){return""}},{key:"table",value:function(e){if(!r.Type.string.isNotEmpty(e))throw new Error(E.errorTableName);return this._queryTable=e,this}},{key:"getQueryTable",value:function(){var e=this._queryTable;if(!r.Type.string.isNotEmpty(e))throw new Error(E.errorTableName);return this.safeKey(e)}},{key:"storeSql",value:function(){var e;try{e=this.build()}catch(e){}return r.Type.string.isNotEmpty(e)&&Be.storeSql(e),this}},{key:"setExecute",value:function(e){this._execute=e}},{key:"exec",value:function(e){var t=this._execute,n=r.Type.string.isNotEmpty(e)?e:this.build();if(!r.Type.string.isNotEmpty(n))throw new Error(E.emptySqlQuery);if(r.Type.object.isNot(t)||r.Type.func.isNot(t.exec))throw new Error(E.errorExecute);return t.exec(n||"")}},{key:"execAll",value:function(e){var t=this._execute;if(e=r.Type.array.isNotEmpty(e=e||[])?e:Be.getStore(),r.Type.object.isNot(t)||r.Type.func.isNot(t.exec))throw new Error(E.errorExecute);var n=[],i=!0,a=!1,u=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var c=o.value;r.Type.string.isNotEmpty(c)&&n.push(t.exec(c))}}catch(e){a=!0,u=e}finally{try{i||null==s.return||s.return()}finally{if(a)throw u}}return Promise.all(n)}},{key:"dialectType",get:function(){var e=this._dialectType;if(!G(N[e]))throw new Error(E.errorDialect);return e},set:function(e){this.setDialect(e)}},{key:"query",get:function(){return this.build()}}]),e}(),De=function(){function e(){a(this,e),this.limitInfo={}}return o(e,[{key:"limitBuild",value:function(e){var t=this.limitInfo;if(!X(t))return e;var r=t.offset,n=t.step;return 0===r?"".concat(e," LIMIT ").concat(n):-1===n?"".concat(e," OFFSET ").concat(r):"".concat(e," LIMIT ").concat(n," OFFSET ").concat(r)}},{key:"limit",value:function(e,t){if(!Le(e))throw new Error(E.errorOffset);if(r.Type.undefined.isNot(t)&&!Le(t))throw new Error(E.errorStep);var n={};r.Type.number.is(e)&&r.Type.number.is(t)&&(n={offset:e,step:t=t||0}),r.Type.number.is(e)&&!r.Type.number.is(t)&&(n={offset:0,step:e}),this.limitInfo=n}},{key:"offset",value:function(e){if(!Le(e))throw new Error(E.errorOffset);this.limitInfo={offset:e,step:-1}}},{key:"step",value:function(e){if(!Le(e))throw new Error(E.errorStep);this.limitInfo={offset:0,step:e}}},{key:"paging",value:function(e,t){if(!Y(e))throw new Error(E.errorPage);if(!Fe(t))throw new Error(E.errorSize);this.limitInfo={offset:(e-1)*t,step:t}}}]),e}(),Me=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).orderSql="",e.orderInfos=[],e}return p(t,Ae),o(t,[{key:"build",value:function(){var e=this,t=this.formatOrderSql();if(r.Type.string.isNotEmpty(t))return t;var n=r.Type.array.safe(this.orderInfos);if(!r.Type.array.isNotEmpty(n))return"";var i=[],a=!0,u=!1,o=void 0;try{for(var s,c=n[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var l=s.value;if(Z(l)){var f=l.type,y=l.list,h=this.safeKey(l.field);if(f!==O.field)i.push("".concat(h," ").concat(f));else{var p=(y||[]).map((function(t){return e.safeValue(t)})).join(", ");i.push("".concat(f,"(").concat(h,", ").concat(p,")"))}}}}catch(e){u=!0,o=e}finally{try{a||null==c.return||c.return()}finally{if(u)throw o}}return r.Type.array.isNotEmpty(i)?(i=Array.from(new Set(i))).join(", "):""}},{key:"orderBuild",value:function(e){var t=this.build();return r.Type.string.isNotEmpty(t)&&(e="".concat(e," ORDER BY ").concat(t)),e}},{key:"descBy",value:function(e,t){var r=d(e,t);return this.orderCache(r,O.desc)}},{key:"ascBy",value:function(e,t){var r=d(e,t);return this.orderCache(r,O.asc)}},{key:"orderField",value:function(e){e=r.Type.object.safe(e);var t=Object.keys(e);return this.orderCache(t,O.field,e)}},{key:"order",value:function(e){this.manualSql(e,"orderSql")}},{key:"formatOrderSql",value:function(){return this.formatManualSql("orderSql")}},{key:"orderCache",value:function(e,t,n){if(!Ie(e))throw new Error(E.errorFields);n=r.Type.object.safe(n);var i=r.Type.array.safe(this.orderInfos),a=!0,u=!1,o=void 0;try{for(var s,c=e[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var l=s.value,f={field:l,type:t};if(t===O.field){var y=n[l];if(!$(y))throw new Error(E.errorValueList);f.list=y}if(!Z(f))throw new Error(E.errorOrderInfo);i.push(f)}}catch(e){u=!0,o=e}finally{try{a||null==c.return||c.return()}finally{if(u)throw o}}return this.orderInfos=i,this}}]),t}(),Ke=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).apply(this,arguments))).queryLimit={},e.queryOrder={},e}return p(t,Ae),o(t,[{key:"getLimitCase",value:function(){var e=this.queryLimit;return e&&e instanceof De||(e=new De,this.queryLimit=e),e}},{key:"limitBuild",value:function(e){return this.getLimitCase().limitBuild(e)}},{key:"offset",value:function(e){return this.getLimitCase().offset(e),this}},{key:"step",value:function(e){return this.getLimitCase().step(e),this}},{key:"getOrderCase",value:function(){var e=this.queryOrder;return e&&e instanceof Me||((e=new Me).setDialect(this.dialectType),this.queryOrder=e),e}},{key:"orderBuild",value:function(e){return this.getOrderCase().orderBuild(e)}},{key:"descBy",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;t>n;n++)r[n-1]=arguments[n];return this.getOrderCase().descBy(e,r),this}},{key:"ascBy",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;t>n;n++)r[n-1]=arguments[n];return this.getOrderCase().ascBy(e,r),this}},{key:"orderField",value:function(e){return this.getOrderCase().orderField(e),this}},{key:"order",value:function(e){return this.getOrderCase().order(e),this}}]),t}(),Ue=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).valuesSql="",e.queryType=T.insert,e.insertData={},e.insertFields=[],e.insertDataArr=[],e}return p(t,Ke),o(t,[{key:"data",value:function(e){if(!je(e))throw new Error(E.errorFieldData);var t=r.Type.object.safe(this.insertData);return this.insertData=Object.assign({},t,e),this}},{key:"fields",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;t>i;i++)n[i-1]=arguments[i];var a=d(e,n),u=r.Type.array.safe(this.insertFields),o=[].concat(u,a);return this.insertFields=Array.from(new Set(o)),this}},{key:"multiData",value:function(e){if(!M(e))throw new Error(E.errorFieldDataArr);var t=r.Type.array.safe(this.insertDataArr);return this.insertDataArr=[].concat(t,e),this}},{key:"values",value:function(e){return this.manualSql(e,"valuesSql"),this}},{key:"formatValuesSql",value:function(){return this.formatManualSql("valuesSql")}},{key:"formatFields",value:function(){var e=this.insertData,t=this.insertFields,r=this.insertDataArr,n=[];if(Ie(t)?n=t:je(e)?n=Object.keys(e):M(r)&&(n=Object.keys(r[0])),!Ie(n))throw new Error(E.errorFields);return n}},{key:"formatValues",value:function(e){var t=this;e=r.Type.array.safe(e);var n="",i=this.formatValuesSql(),a=this.insertData,u=this.insertDataArr,o=[],s=function(r){var n=e.map((function(e){return t.safeValue(r[e])})).join(", ");return"( ".concat(n," )")};if(r.Type.string.isNotEmpty(i)?n=i:je(a)?n=s(a):M(u)&&(n=function(e){var t=!0,n=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(t=(a=u.next()).done);t=!0){var c=a.value;r.Type.object.isNotEmpty(c)&&o.push(s(c))}}catch(e){n=!0,i=e}finally{try{t||null==u.return||u.return()}finally{if(n)throw i}}return o.join(", ")}(u)),!r.Type.string.isNotEmpty(n))throw new Error(E.errorInsertValues);return"VALUES ".concat(n)}},{key:"build",value:function(){var e=this,t=this.queryType,r=this.getQueryTable(),n=this.formatFields(),i=this.formatValues(n),a=n.map((function(t){return e.safeKey(t)})).join(", ");return"".concat(t," INTO ").concat(r," ( ").concat(a," )  ").concat(i)}}]),t}();var Ve=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},Re=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).termSql="",e.termInfos=[],e.termBrackets=[],e}return p(t,Ae),o(t,[{key:"build",value:function(){return this.termsBuild()}},{key:"termsBuild",value:function(){var e=this.formatTermSql();if(r.Type.string.isNotEmpty(e))return e;var t=this.termInfos,n=this.termBrackets;return r.Type.array.isNotEmpty(t)?r.Type.array.isNotEmpty(n)?this.formatTermBrackets(n,t):this.formatTerms(t):""}},{key:"formatTermSql",value:function(){return this.formatManualSql("termSql")}},{key:"formatTermBrackets",value:function(e,t){var n="";e=r.Type.array.safe(e),t=r.Type.array.safe(t);for(var i=e.length,a=t.length,u=0;i>u;u++){var o=e[u],s=e[u-1],c=e[u+1];if(!pe(o))throw new Error(E.errorTermBracket);var l=o.position,f=o.logic,y=0,h=a;pe(s)&&(y=s.position),pe(c)&&(h=c.position);var p=t.slice(y,l),v=t.slice(l,h),d=this.formatBracketTerm(1===i||u+1===i||h===a,f,p,v);r.Type.string.isNotEmpty(d)&&(n=r.Type.string.isNotEmpty(n)?"".concat(n," ").concat(d):d)}return n}},{key:"formatBracketTerm",value:function(e,t,n,i){n=r.Type.array.safe(n),i=r.Type.array.safe(i);var a=this.formatTerms(n);if(0>=n.length||0>=i.length)return"";if(e){var u=this.formatTerms(i);return"( ".concat(a," ) ").concat(t," ( ").concat(u," )")}return"( ".concat(a," ) ").concat(t)}},{key:"formatTerms",value:function(e){e=r.Type.array.safe(e);var t="",n=!0,i=!1,a=void 0;try{for(var u,o=e[Symbol.iterator]();!(n=(u=o.next()).done);n=!0){var s=u.value;if(!ve(s))throw new Error(E.errorTermInfo);var c=this.safeKey(s.field),l=s.sign,f=s.logic,y=this.formatTermValue(s.value,l),h="".concat(c," ").concat(l," ").concat(y);r.Type.string.isNotEmpty(t)?t="".concat(t," ").concat(f," ").concat(h):t=h}}catch(e){i=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw a}}return t}},{key:"formatTermValue",value:function(e,t){var r,n=this;if(t===q.in||t===q.notIn){if(!ye(e))throw new Error(E.errorTermValue);return r=e.map((function(e){return n.safeValue(e)})).join(", "),"( ".concat(r," )")}if(t===q.between||t===q.notBetween){if(!he(e))throw new Error(E.errorTermValue);var i=this.safeValue(e[0]),a=this.safeValue(e[1]);return"".concat(i," AND ").concat(a)}if(!fe(e))throw new Error(E.errorTermValue);return t!==q.like&&t!==q.notlike||(e="%".concat(e,"%")),r=this.safeValue(e)}},{key:"termCache",value:function(e,t,n){if(!se(e))throw new Error(E.errorTermdata);if(!ce(t))throw new Error(E.errorTermSign);if(!le(n))throw new Error(E.errorTermLogic);for(var i=r.Type.array.safe(this.termInfos),a=[],u=0,o=Object.keys(e);o.length>u;u++){var s=o[u],c=e[s];switch(t){case q.in:case q.notIn:if(!ye(c))throw new Error(E.errorTermValue);break;case q.between:case q.notBetween:if(!he(c))throw new Error(E.errorTermValue);break;default:if(!fe(c))throw new Error(E.errorTermValue)}a.push({field:s,value:c,sign:t,logic:n})}return this.termInfos=[].concat(i,a),this}},{key:"bracketTerm",value:function(e){var t=r.Type.array.safe(this.termInfos),n=r.Type.array.safe(this.termBrackets),i=t.length;if(0>=i)return this;var a=!0,u=!1,o=void 0;try{for(var s,c=n[Symbol.iterator]();!(a=(s=c.next()).done);a=!0){var l=s.value;if(pe(l))if(l.position===i)return this}}catch(e){u=!0,o=e}finally{try{a||null==c.return||c.return()}finally{if(u)throw o}}var f={position:i,logic:e};return pe(f)&&n.push(f),this.termBrackets=n,this}},{key:"sqlTerm",value:function(e){this.manualSql(e,"termSql")}},{key:"equal",value:function(e){return this.and(e,q.equal)}},{key:"notEqual",value:function(e){return this.and(e,q.notEqual)}},{key:"in",value:function(e){return this.and(e,q.in)}},{key:"notIn",value:function(e){return this.and(e,q.notIn)}},{key:"more",value:function(e){return this.and(e,q.more)}},{key:"less",value:function(e){return this.and(e,q.less)}},{key:"moreEqual",value:function(e){return this.and(e,q.moreEqual)}},{key:"lessEqual",value:function(e){return this.and(e,q.lessEqual)}},{key:"like",value:function(e){return this.and(e,q.like)}},{key:"notLike",value:function(e){return this.and(e,q.notlike)}},{key:"between",value:function(e){return this.and(e,q.between)}},{key:"notBetween",value:function(e){return this.and(e,q.notBetween)}},{key:"orEqual",value:function(e){return this.or(e,q.equal)}},{key:"orNotEqual",value:function(e){return this.or(e,q.notEqual)}},{key:"orIn",value:function(e){return this.or(e,q.in)}},{key:"orNotIn",value:function(e){return this.or(e,q.notIn)}},{key:"orMore",value:function(e){return this.or(e,q.more)}},{key:"orLess",value:function(e){return this.or(e,q.less)}},{key:"orMoreEqual",value:function(e){return this.or(e,q.moreEqual)}},{key:"orLessEqual",value:function(e){return this.or(e,q.lessEqual)}},{key:"orLike",value:function(e){return this.or(e,q.like)}},{key:"orBetween",value:function(e){return this.or(e,q.between)}},{key:"orNotBetween",value:function(e){return this.or(e,q.notBetween)}},{key:"orNotLike",value:function(e){return this.or(e,q.notlike)}},{key:"bracket",value:function(){return this.bracketTerm(k.and)}},{key:"orBracket",value:function(){return this.bracketTerm(k.or)}},{key:"and",value:function(e,t){return this.termCache(e,t,k.and)}},{key:"or",value:function(e,t){return this.termCache(e,t,k.or)}}]),t}(),Pe=["CURRENT_TIMESTAMP"],_e="{{field}}{{type}}{{unsigned}}{{notNull}}{{default}}{{autoIncrement}}{{onUpdate}}{{comment}}",Ge={equal:"whereEqual",notEqual:"whereNotEqual",in:"whereIn",notIn:"whereNotIn",more:"whereMore",less:"whereLess",moreEqual:"whereMoreEqual",lessEqual:"whereLessEqual",like:"whereLike",notLike:"whereNotLike",between:"whereBetween",notBetween:"whereNotBetween",orEqual:"whereOrEqual",orNotEqual:"whereOrNotEqual",orIn:"whereOrIn",orNotIn:"whereOrNotIn",orMore:"whereOrMore",orLess:"whereOrLess",orMoreEqual:"whereOrMoreEqual",orLessEqual:"whereOrLessEqual",orLike:"whereOrLike",orNotLike:"whereOrNotLike",orBetween:"whereOrBetween",orNotBetween:"whereOrNotBetween"},He={equal:"havingEqual",notEqual:"havingNotEqual",in:"havingIn",notIn:"havingNotIn",more:"havingMore",less:"havingLess",moreEqual:"havingMoreEqual",lessEqual:"havingLessEqual",like:"havingLike",notLike:"havingNotLike",between:"havingBetween",notBetween:"havingNotBetween",orEqual:"havingOrEqual",orNotEqual:"havingOrNotEqual",orIn:"havingOrIn",orNotIn:"havingOrNotIn",orMore:"havingOrMore",orLess:"havingOrLess",orMoreEqual:"havingOrMoreEqual",orLessEqual:"havingOrLessEqual",orLike:"havingOrLike",orNotLike:"havingOrNotLike",orBetween:"havingOrBetween",orNotBetween:"havingOrNotBetween"},Qe=Object.values(B),We=function(e){function t(){var e;a(this,t),(e=f(this,y(t).call(this))).termStatus="",e.equal=function(t){return Ve(e)},e.notEqual=function(t){return Ve(e)},e.in=function(t){return Ve(e)},e.notIn=function(t){return Ve(e)},e.more=function(t){return Ve(e)},e.less=function(t){return Ve(e)},e.moreEqual=function(t){return Ve(e)},e.lessEqual=function(t){return Ve(e)},e.like=function(t){return Ve(e)},e.notLike=function(t){return Ve(e)},e.between=function(t){return Ve(e)},e.notBetween=function(t){return Ve(e)},e.orEqual=function(t){return Ve(e)},e.orNotEqual=function(t){return Ve(e)},e.orIn=function(t){return Ve(e)},e.orNotIn=function(t){return Ve(e)},e.orMore=function(t){return Ve(e)},e.orLess=function(t){return Ve(e)},e.orMoreEqual=function(t){return Ve(e)},e.orLessEqual=function(t){return Ve(e)},e.orLike=function(t){return Ve(e)},e.orNotLike=function(t){return Ve(e)},e.orBetween=function(t){return Ve(e)},e.orNotBetween=function(t){return Ve(e)};for(var r=function(){var t=i[n];e[t]=function(e){return this.termApiFn(t,e)}},n=0,i=Object.keys(Ge);i.length>n;n++)r();return e}return p(t,Ke),o(t,[{key:"termApiFn",value:function(e,t){var r=this.termStatus;if(!Qe.includes(r))throw new Error(E.errorTermStatus);return this.getTermCase(r)[e](t),this}},{key:"bracket",value:function(){var e=this.termStatus;if(!Qe.includes(e))throw new Error(E.errorTermStatus);return this.getTermCase(e).bracket(),this}},{key:"orBracket",value:function(){var e=this.termStatus;if(!Qe.includes(e))throw new Error(E.errorTermStatus);return this.getTermCase(e).orBracket(),this}},{key:"getTermCase",value:function(e){var t=this[e];return t&&t instanceof Re||((t=new Re).setDialect(this.dialectType),this[e]=t),t}}]),t}(),Ye=function(e){function t(){var e;a(this,t),(e=f(this,y(t).call(this))).whereTerm={},e.whereEqual=function(t){return Ve(e)},e.whereNotEqual=function(t){return Ve(e)},e.whereIn=function(t){return Ve(e)},e.whereNotIn=function(t){return Ve(e)},e.whereMore=function(t){return Ve(e)},e.whereLess=function(t){return Ve(e)},e.whereMoreEqual=function(t){return Ve(e)},e.whereLessEqual=function(t){return Ve(e)},e.whereLike=function(t){return Ve(e)},e.whereNotLike=function(t){return Ve(e)},e.whereBetween=function(t){return Ve(e)},e.whereNotBetween=function(t){return Ve(e)},e.whereOrEqual=function(t){return Ve(e)},e.whereOrNotEqual=function(t){return Ve(e)},e.whereOrIn=function(t){return Ve(e)},e.whereOrNotIn=function(t){return Ve(e)},e.whereOrMore=function(t){return Ve(e)},e.whereOrLess=function(t){return Ve(e)},e.whereOrMoreEqual=function(t){return Ve(e)},e.whereOrLessEqual=function(t){return Ve(e)},e.whereOrLike=function(t){return Ve(e)},e.whereOrNotLike=function(t){return Ve(e)},e.whereOrBetween=function(t){return Ve(e)},e.whereOrNotBetween=function(t){return Ve(e)};for(var r=function(){var t=i[n];e[Ge[t]]=function(e){return this.whereTermApiFn(t,e)}},n=0,i=Object.keys(Ge);i.length>n;n++)r();return e}return p(t,We),o(t,[{key:"whereTermApiFn",value:function(e,t){return this.getWhereTermCase()[e](t),this}},{key:"whereBracket",value:function(){return this.getWhereTermCase().bracket(),this}},{key:"whereOrBracket",value:function(){return this.getWhereTermCase().orBracket(),this}},{key:"where",value:function(e){if(r.Type.undefined.isNot(e)){var t=this.getWhereTermCase();r.Type.func.is(e)&&(e=e.bind(this,t)),t.sqlTerm(e)}else this.termStatus=B.where;return this}},{key:"getWhereTermCase",value:function(){return this.getTermCase(B.where)}},{key:"whereBuild",value:function(e){var t=this.getWhereTermCase().termsBuild();return r.Type.string.isNotEmpty(t)&&(e="".concat(e," WHERE ").concat(t)),e}}]),t}(),Xe=function(e){function t(){var e;a(this,t),(e=f(this,y(t).call(this))).havingTerm={},e.havingEqual=function(t){return Ve(e)},e.havingNotEqual=function(t){return Ve(e)},e.havingIn=function(t){return Ve(e)},e.havingNotIn=function(t){return Ve(e)},e.havingMore=function(t){return Ve(e)},e.havingLess=function(t){return Ve(e)},e.havingMoreEqual=function(t){return Ve(e)},e.havingLessEqual=function(t){return Ve(e)},e.havingLike=function(t){return Ve(e)},e.havingNotLike=function(t){return Ve(e)},e.havingBetween=function(t){return Ve(e)},e.havingNotBetween=function(t){return Ve(e)},e.havingOrEqual=function(t){return Ve(e)},e.havingOrNotEqual=function(t){return Ve(e)},e.havingOrIn=function(t){return Ve(e)},e.havingOrNotIn=function(t){return Ve(e)},e.havingOrMore=function(t){return Ve(e)},e.havingOrLess=function(t){return Ve(e)},e.havingOrMoreEqual=function(t){return Ve(e)},e.havingOrLessEqual=function(t){return Ve(e)},e.havingOrLike=function(t){return Ve(e)},e.havingOrNotLike=function(t){return Ve(e)},e.havingOrBetween=function(t){return Ve(e)},e.havingOrNotBetween=function(t){return Ve(e)};for(var r=function(){var t=i[n];e[He[t]]=function(e){return this.havingTermApiFn(t,e)}},n=0,i=Object.keys(He);i.length>n;n++)r();return e}return p(t,Ye),o(t,[{key:"havingTermApiFn",value:function(e,t){return this.getHavingTermCase()[e](t),this}},{key:"havingBracket",value:function(){return this.getHavingTermCase().bracket(),this}},{key:"havingOrBracket",value:function(){return this.getHavingTermCase().orBracket(),this}},{key:"having",value:function(e){if(r.Type.undefined.isNot(e)){var t=this.getHavingTermCase();r.Type.func.is(e)&&(e=e.bind(this,t)),t.sqlTerm(e)}else this.termStatus=B.having;return this}},{key:"getHavingTermCase",value:function(){return this.getTermCase(B.having)}},{key:"havingBuild",value:function(e){var t=this.getHavingTermCase().termsBuild();return r.Type.string.isNotEmpty(t)&&(e="".concat(e," HAVING ").concat(t)),e}}]),t}(),Je=function(e){function t(){return a(this,t),f(this,y(t).apply(this,arguments))}return p(t,Ae),o(t,[{key:"funcField",value:function(e,t){var n=r.Type.string.isNotEmpty(t)&&"*"!==t,i=n?t:r.Type.number.is(t)?t+"":"*",a=n?this.safeKey(i):i;return{funcFeild:"".concat(e,"(").concat(a,")")}}},{key:"count",value:function(e){return this.funcField(w.count,e)}},{key:"sum",value:function(e){return this.funcField(w.sum,e)}},{key:"max",value:function(e){return this.funcField(w.max,e)}},{key:"min",value:function(e){return this.funcField(w.min,e)}},{key:"avg",value:function(e){return this.funcField(w.avg,e)}},{key:"abs",value:function(e){return this.funcField(w.abs,e)}},{key:"ceil",value:function(e){return this.funcField(w.ceil,e)}},{key:"floor",value:function(e){return this.funcField(w.floor,e)}},{key:"round",value:function(e){return this.funcField(w.round,e)}},{key:"log",value:function(e){return this.funcField(w.log,e)}},{key:"log2",value:function(e){return this.funcField(w.log2,e)}},{key:"exp",value:function(e){return this.funcField(w.exp,e)}},{key:"power",value:function(e){return this.funcField(w.power,e)}},{key:"acos",value:function(e){return this.funcField(w.acos,e)}},{key:"asin",value:function(e){return this.funcField(w.asin,e)}},{key:"atan",value:function(e){return this.funcField(w.atan,e)}},{key:"cos",value:function(e){return this.funcField(w.cos,e)}},{key:"sin",value:function(e){return this.funcField(w.sin,e)}},{key:"tan",value:function(e){return this.funcField(w.tan,e)}},{key:"conv",value:function(e){return this.funcField(w.conv,e)}},{key:"random",value:function(e){return this.funcField(w.random,e)}},{key:"rand",value:function(e){return this.funcField(w.rand,e)}},{key:"radians",value:function(e){return this.funcField(w.radians,e)}},{key:"degrees",value:function(e){return this.funcField(w.degrees,e)}},{key:"distinct",value:function(e){return this.funcField(w.distinct,e)}}]),t}(),ze=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).funcInstance={},e.groupByFields=[],e.combineFuncs=[],e}return p(t,Xe),o(t,[{key:"groupBuild",value:function(e){var t=this,n=this.groupByFields;if(!r.Type.array.isNotEmpty(n))return e;var i=n.map((function(e){return t.safeKey(e)})).join(", ");return e="".concat(e," GROUP BY ").concat(i)}},{key:"groupBy",value:function(){for(var e=r.Type.array.safe(this.groupByFields),t=arguments.length,n=new Array(t),i=0;t>i;i++)n[i]=arguments[i];if(!Ie(n))throw new Error(E.errorFields);return e=e.concat(n),this.groupByFields=Array.from(new Set(e)),this}},{key:"getFuncCase",value:function(){var e=this.funcInstance;return e&&e instanceof Je||((e=new Je).setDialect(this.dialectType),this.funcInstance=e),e}},{key:"formatFuncs",value:function(){var e=r.Type.array.safe(this.combineFuncs),t=[],n=!0,i=!1,a=void 0;try{for(var u,o=e[Symbol.iterator]();!(n=(u=o.next()).done);n=!0){var s=u.value;if(!V(s))throw new Error(E.errorFuncInfo);t.push(s.funcFeild)}}catch(e){i=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw a}}return t=Array.from(new Set(t))}},{key:"funcsCache",value:function(e){var t=r.Type.array.safe(this.combineFuncs);return V(e)&&t.push(e),this.combineFuncs=t,this}},{key:"funcFeilds",value:function(){for(var e=arguments.length,t=new Array(e),n=0;e>n;n++)t[n]=arguments[n];for(var i=0,a=t;a.length>i;i++){var u=a[i];if(u=r.Type.object.safe(u),V(u))this.funcsCache(u);else{var o=this.getFuncCase();if(R(u)){var s=u.func,c=u.field;if(r.Type.object.is(o)&&r.Type.func.is(o[s])){var l=o[s].call(o,c);this.funcsCache(l)}}else;}}return this}},{key:"count",value:function(e){var t=this.getFuncCase().count(e);return this.funcsCache(t)}},{key:"sum",value:function(e){var t=this.getFuncCase().sum(e);return this.funcsCache(t)}},{key:"max",value:function(e){var t=this.getFuncCase().max(e);return this.funcsCache(t)}},{key:"min",value:function(e){var t=this.getFuncCase().min(e);return this.funcsCache(t)}},{key:"avg",value:function(e){var t=this.getFuncCase().avg(e);return this.funcsCache(t)}},{key:"abs",value:function(e){var t=this.getFuncCase().abs(e);return this.funcsCache(t)}},{key:"ceil",value:function(e){var t=this.getFuncCase().ceil(e);return this.funcsCache(t)}},{key:"floor",value:function(e){var t=this.getFuncCase().floor(e);return this.funcsCache(t)}},{key:"round",value:function(e){var t=this.getFuncCase().round(e);return this.funcsCache(t)}},{key:"log",value:function(e){var t=this.getFuncCase().log(e);return this.funcsCache(t)}},{key:"log2",value:function(e){var t=this.getFuncCase().log2(e);return this.funcsCache(t)}},{key:"exp",value:function(e){var t=this.getFuncCase().exp(e);return this.funcsCache(t)}},{key:"power",value:function(e){var t=this.getFuncCase().power(e);return this.funcsCache(t)}},{key:"acos",value:function(e){var t=this.getFuncCase().acos(e);return this.funcsCache(t)}},{key:"asin",value:function(e){var t=this.getFuncCase().asin(e);return this.funcsCache(t)}},{key:"atan",value:function(e){var t=this.getFuncCase().atan(e);return this.funcsCache(t)}},{key:"cos",value:function(e){var t=this.getFuncCase().cos(e);return this.funcsCache(t)}},{key:"sin",value:function(e){var t=this.getFuncCase().sin(e);return this.funcsCache(t)}},{key:"tan",value:function(e){var t=this.getFuncCase().tan(e);return this.funcsCache(t)}},{key:"conv",value:function(e){var t=this.getFuncCase().conv(e);return this.funcsCache(t)}},{key:"random",value:function(e){var t=this.getFuncCase().random(e);return this.funcsCache(t)}},{key:"rand",value:function(e){var t=this.getFuncCase().rand(e);return this.funcsCache(t)}},{key:"radians",value:function(e){var t=this.getFuncCase().radians(e);return this.funcsCache(t)}},{key:"degrees",value:function(e){var t=this.getFuncCase().degrees(e);return this.funcsCache(t)}},{key:"distinct",value:function(e){var t=this.getFuncCase().distinct(e);return this.funcsCache(t)}}]),t}(),Ze=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).queryTables=[],e.tableFieldsMap={},e.tableFieldsAsMap={},e.joinTypeInfos=[],e}return p(t,ze),o(t,[{key:"getQueryTables",value:function(){var e=this;return r.Type.array.safe(this.queryTables).map((function(t){return e.safeKey(t)})).join(", ")}},{key:"formatJoinFields",value:function(){for(var e=r.Type.object.safe(this.tableFieldsMap),t=r.Type.object.safe(this.tableFieldsAsMap),n=[],i=0,a=Object.keys(e);a.length>i;i++){var u=a[i],o=r.Type.array.safe(e[u]),s=r.Type.object.safe(t[u]),c=this.safeKey(u),l=!0,f=!1,y=void 0;try{for(var h,p=o[Symbol.iterator]();!(l=(h=p.next()).done);l=!0){var v=h.value;if(r.Type.string.isNotEmpty(v)){var d=this.safeKey(v),m="".concat(c,".").concat(d);if(r.Type.string.isNotEmpty(s[v])){var g=this.safeKey(s[v]);n.push("".concat(m," AS ").concat(g))}else n.push(m)}}}catch(e){f=!0,y=e}finally{try{l||null==p.return||p.return()}finally{if(f)throw y}}}return n}},{key:"joinBuild",value:function(e){var t=r.Type.array.safe(this.joinTypeInfos);if(!r.Type.array.isNotEmpty(t))return e;var n=[],i=!0,a=!1,u=void 0;try{for(var o,s=t[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var c=o.value,l=c.type,f=r.Type.object.safe(c.info),y=f.tableName,h=r.Type.array.safe(f.termInfos),p=this.joinTermBuild(h),v=this.safeKey(y),d="".concat(l," JOIN ").concat(v);if(r.Type.array.isNotEmpty(p)){var m=p.join(" AND ");d+=" ON ".concat(m)}n.push(d)}}catch(e){a=!0,u=e}finally{try{i||null==s.return||s.return()}finally{if(a)throw u}}if(!r.Type.array.isNotEmpty(n))return e;var g=n.join(" ");return e="".concat(e," ").concat(g)}},{key:"joinTermBuild",value:function(e){var t=[],n=!0,i=!1,a=void 0;try{for(var u,o=e[Symbol.iterator]();!(n=(u=o.next()).done);n=!0){for(var s=u.value,c=s.symbol,l=s.tableFields,f="",y=0,h=Object.keys(l);h.length>y;y++){var p=h[y],v=l[p],d=this.safeKey(p),m=this.safeKey(v);r.Type.string.isNotEmpty(f)&&(f+=" ".concat(c," ")),f+="".concat(d,".").concat(m)}t.push("(".concat(f,")"))}}catch(e){i=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw a}}return t}},{key:"multiTables",value:function(e){for(var t=r.Type.array.safe(this.queryTables),n=arguments.length,i=new Array(n>1?n-1:0),a=1;n>a;a++)i[a-1]=arguments[a];var u=d(e,i),o=[],s=!0,c=!1,l=void 0;try{for(var f,y=u[Symbol.iterator]();!(s=(f=y.next()).done);s=!0){var h=f.value;r.Type.string.isNotEmpty(h)&&o.push(h)}}catch(e){c=!0,l=e}finally{try{s||null==y.return||y.return()}finally{if(c)throw l}}return this.queryTables=Array.from(new Set(t.concat(o))),this}},{key:"tableFields",value:function(e){var t=r.Type.object.safe(this.tableFieldsMap);if(!qe(e))throw new Error(E.tableFieldsError);return this.tableFieldsMap=Object.assign({},t,e),this}},{key:"tableAsMap",value:function(e){var t=r.Type.object.safe(this.tableFieldsAsMap);if(!Se(e))throw new Error(E.tableFieldsAsMapError);return this.tableFieldsAsMap=Object.assign({},t,e),this}},{key:"join",value:function(e,t){var n=r.Type.array.safe(this.joinTypeInfos);if(!Oe(e))throw new Error(E.joinTableInfoError);return n.push({type:t,info:e}),this.joinTypeInfos=n,this}},{key:"innerJoin",value:function(e){return this.join(e,x.inner),this}},{key:"leftJoin",value:function(e){return this.join(e,x.left),this}},{key:"rightJoin",value:function(e){return this.join(e,x.right),this}}]),t}(),$e=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).selectFields=[],e.fieldsAsMap={},e}return p(t,Ze),o(t,[{key:"formatFields",value:function(){var e=r.Type.array.safe(this.selectFields),t=r.Type.object.safe(this.fieldsAsMap),n=[],i=!0,a=!1,u=void 0;try{for(var o,s=e[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var c=o.value;if(r.Type.string.isNotEmpty(c)){var l="*"!==c?this.safeKey(c):"*";if(r.Type.string.isNotEmpty(t[c])){var f=this.safeKey(t[c]);n.push("".concat(l," AS ").concat(f))}else n.push(l)}}}catch(e){a=!0,u=e}finally{try{i||null==s.return||s.return()}finally{if(a)throw u}}return n}},{key:"formatFieldStr",value:function(){var e,t=this.formatFields(),n=this.formatJoinFields(),i=this.formatFuncs();return Ie(t)||Ie(i)||Ie(n)?(t=r.Type.array.safe(t),n=r.Type.array.safe(n),i=r.Type.array.safe(i),e=[].concat(t,n,i).join(", ")):e="*",e}},{key:"formatTableStr",value:function(){var e=this.getQueryTables();return r.Type.string.isNotEmpty(e)?e:this.getQueryTable()}},{key:"build",value:function(){var e=this.formatTableStr(),t=this.formatFieldStr(),r="".concat(T.select," ").concat(t," FROM ").concat(e);return r=this.whereBuild(r),r=this.groupBuild(r),r=this.havingBuild(r),r=this.orderBuild(r),r=this.limitBuild(r),r=this.joinBuild(r)}},{key:"fields",value:function(e){for(var t=r.Type.array.safe(this.selectFields),n=arguments.length,i=new Array(n>1?n-1:0),a=1;n>a;a++)i[a-1]=arguments[a];var u=d(e,i),o=[],s=!0,c=!1,l=void 0;try{for(var f,y=u[Symbol.iterator]();!(s=(f=y.next()).done);s=!0){var h=f.value;r.Type.object.isNotEmpty(h)?this.funcFeilds(h):r.Type.string.isNotEmpty(h)&&o.push(h)}}catch(e){c=!0,l=e}finally{try{s||null==y.return||y.return()}finally{if(c)throw l}}return this.selectFields=Array.from(new Set(t.concat(o))),this.selectFields.includes("*")&&(this.selectFields=["*"]),this}},{key:"asMap",value:function(e){var t=r.Type.object.safe(this.fieldsAsMap);if(!Ce(e))throw new Error(E.errorFieldMap);return this.fieldsAsMap=Object.assign({},t,e),this}},{key:"limit",value:function(e,t){return this.getLimitCase().limit(e,t),this}},{key:"paging",value:function(e,t){return this.getLimitCase().paging(e,t),this}},{key:"findOne",value:function(){return this.getLimitCase().step(1),this}}]),t}(),et=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).updateInfos={},e}return p(t,Ye),o(t,[{key:"build",value:function(){var e=this.getQueryTable(),t=this.formatData().join(", "),r="".concat(T.update," ").concat(e," SET ").concat(t);return r=this.whereBuild(r),r=this.orderBuild(r),r=this.limitBuild(r)}},{key:"formatData",value:function(){var e=this.updateInfos;if(!r.Type.object.isNotEmpty(e))throw new Error(E.emptyUpdateInfo);for(var t=[],n=0,i=Object.keys(e);i.length>n;n++){var a=i[n],u=e[a];if(de(u)){var o=u.type,s=this.safeValue(u.value),c=this.safeKey(a),l="";switch(o){case I.set:l="".concat(c," = ").concat(s);break;case I.add:l="".concat(c," = ").concat(c," + ").concat(s);break;case I.minus:l="".concat(c," = ").concat(c," - ").concat(s)}r.Type.string.isNotEmpty(l)&&t.push(l)}}if(!Ie(t))throw new Error(E.emptyUpdateInfo);return t}},{key:"updateCache",value:function(e,t){if(!je(e))throw new Error(E.errorFieldData);for(var n=r.Type.object.safe(this.updateInfos),i=0,a=Object.keys(e);a.length>i;i++){var u=a[i],o={value:e[u],type:t};if(!de(o))throw new Error(E.errorUpdateInfo);n[u]=o}return this.updateInfos=n,this}},{key:"set",value:function(e){return this.updateCache(e,I.set)}},{key:"add",value:function(e){return this.updateCache(e,I.add)}},{key:"minus",value:function(e){return this.updateCache(e,I.minus)}}]),t}(),tt=function(e){function t(){return a(this,t),f(this,y(t).apply(this,arguments))}return p(t,Ye),o(t,[{key:"build",value:function(){var e=this.getQueryTable(),t="".concat(T.delete," FROM ").concat(e);return t=this.whereBuild(t),t=this.orderBuild(t),t=this.limitBuild(t)}}]),t}(),rt=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).queryType=T.replace,e}return p(t,Ue),t}(),nt=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).createTableSqlStr="",e.createDbName="",e.createTableInfo={},e}return p(t,Ae),o(t,[{key:"checkDialect",value:function(){if(this._dialectType!==g.mysql)throw new Error(E.notSupportDialect)}},{key:"info",value:function(e){return r.Type.string.isNotEmpty(e)?this.createTableSqlStr=e:Te(e,!0)&&(this.createTableInfo=e),this}},{key:"dataBase",value:function(e){if(!r.Type.string.isNotEmpty(e))throw new Error(E.errorCreateDbName);return this.createDbName=e,this}},{key:"build",value:function(){var e=this.createDbName;if(r.Type.string.isNotEmpty(e))return v("CREATE DATABASE {{dbName}}",{dbName:e});var t=this.createTableSqlStr;if(r.Type.string.isNotEmpty(t))return t;var n=this.createTableInfo;return Te(n,!0),this.tableTmpl(n)}},{key:"tableTmpl",value:function(e){return v("CREATE TABLE IF NOT EXISTS {{tableName}}( {{feildsStr}}) {{tableOptionsStr}}",{tableName:e.tableName,feildsStr:this.feildsStr(e),tableOptionsStr:this.tableOptsStr(e)})+";"}},{key:"feildsStr",value:function(e){var t=e.primaryKey,n=e.uniqueKey,i=e.fields,a=[],u=!0,o=!1,s=void 0;try{for(var c,l=i[Symbol.iterator]();!(u=(c=l.next()).done);u=!0){var f=this.feildTmpl(c.value);a.push(f)}}catch(e){o=!0,s=e}finally{try{u||null==l.return||l.return()}finally{if(o)throw s}}var y=this.primaryKeyStr(t),h=this.uniqueKeyStr(n);return r.Type.string.isNotEmpty(y)&&a.push(y),r.Type.string.isNotEmpty(h)&&a.push(h),a.join(",")}},{key:"feildTmpl",value:function(e){var t=this.safeKey(e.field),n=e.type.toUpperCase(),i=e.notNull,a=e.default,u=e.autoIncrement,o=e.onUpdate,s=e.comment,c={field:t,type:n};if(!0===e.unsigned&&(c.unsigned=L.unsigned),!0===i&&(c.notNull=L.notNull),r.Type.string.is(a)||r.Type.number.is(a)){var l,f=!0;r.Type.string.is(a)&&(l=a.toUpperCase(),f=!Pe.includes(l)),a=f?this.safeValue(a):l,c.default="".concat(L.default," ").concat(a)}return!0===u&&(c.autoIncrement=L.autoIncrement),r.Type.string.isNotEmpty(o)&&(c.onUpdate="".concat(L.onUpdate," ").concat(o)),r.Type.string.isNotEmpty(s)&&(s=this.safeValue(s),c.comment="".concat(L.comment," ").concat(s)),v(_e,c)}},{key:"primaryKeyStr",value:function(e){var t=this,n="",i=L.primaryKey;if(r.Type.string.isNotEmpty(e)){var a=this.safeKey(e);n="".concat(a," ").concat(i," (").concat(a,")")}if(r.Type.object.is(e)){var u=this.safeKey(e.keyName),o=e.combineFields.map((function(e){return t.safeKey(e)})).join(",");n="".concat(u," ").concat(i," (").concat(o,")")}return"".concat(L.constraint," ").concat(n)}},{key:"uniqueKeyStr",value:function(e){var t=this,n="",i=L.uniqueKey;if(r.Type.string.isNotEmpty(e)){var a=this.safeKey(e);n="".concat(a," ").concat(i," (").concat(a,")")}if(r.Type.object.is(e)){var u=this.safeKey(e.keyName),o=e.combineFields.map((function(e){return t.safeKey(e)})).join(",");n="".concat(u," ").concat(i," (").concat(o,")")}return"".concat(L.constraint," ").concat(n)}},{key:"tableOptsStr",value:function(e){var t=e.engine,n=e.autoIncrement,i=e.defaultCharset,a=e.comment,u={};if(r.Type.string.isNotEmpty(t)){var o=t;u.engine="".concat(L.engine,"=").concat(o)}if(r.Type.number.is(n)){var s=n;u.autoIncrement="".concat(L.autoIncrement,"=").concat(s)}if(r.Type.string.isNotEmpty(i)){var c=i;u.defaultCharset="".concat(L.defaultCharset,"=").concat(c)}if(r.Type.string.isNotEmpty(a)){var l=L.comment,f=this.safeValue(a);u.comment="".concat(l,"=").concat(f)}return v("{{engine}}{{autoIncrement}}{{defaultCharset}}{{comment}}",u)}}]),t}(),it=function(e){function t(){var e;return a(this,t),(e=f(this,y(t).call(this))).alterInfos=[],e}return p(t,Ae),o(t,[{key:"checkDialect",value:function(){if(this._dialectType!==g.mysql)throw new Error(E.notSupportDialect)}},{key:"add",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return r.Type.object.is(e)&&(e=(t=e).field||""),delete t.field,this.alterCache(j.add,e,t)}},{key:"drop",value:function(e){return this.alterCache(j.drop,e,{})}},{key:"modify",value:function(e,t){return delete t.field,this.alterCache(j.modify,e,t)}},{key:"change",value:function(e,t){return this.alterCache(j.change,e,t)}},{key:"alterCache",value:function(e,t,n){if(j.drop!==e&&!r.Type.object.isNotEmpty(n))throw new Error(E.errorAlterField);var i={method:e,field:t,alterField:n};if(!ke(i))throw new Error(E.errorAlterField);var a=r.Type.array.safe(this.alterInfos);return a.push(i),this.alterInfos=a,this}},{key:"build",value:function(){var e=r.Type.array.safe(this.alterInfos),t=[],n=!0,i=!1,a=void 0;try{for(var u,o=e[Symbol.iterator]();!(n=(u=o.next()).done);n=!0){var s=u.value;if(ke(s)){var c=v("{{method}}COLUMN {{field}}{{alterFieldStr}}",{method:s.method,field:this.safeKey(s.field),alterFieldStr:this.feildTmpl(s.alterField)});t.push(c)}}}catch(e){i=!0,a=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw a}}if(!r.Type.array.isNotEmpty(t))throw new Error(E.emptyAlterInfos);var l=t.join(",");return v("ALTER TABLE {{queryTable}}{{alterInfosStr}}",{queryTable:this.getQueryTable(),alterInfosStr:l})}},{key:"feildTmpl",value:function(e){var t=e.field,n=e.type,i=e.unsigned,a=e.notNull,u=e.default,o=e.autoIncrement,s=e.onUpdate,c=e.comment,l={};if(r.Type.string.isNotEmpty(t)&&(l.field=this.safeKey(t)),r.Type.string.isNotEmpty(n)&&(l.type=n.toUpperCase()),!0===i&&(l.unsigned=L.unsigned),!0===a&&(l.notNull=L.notNull),r.Type.string.is(u)||r.Type.number.is(u)){var f,y=!0;r.Type.string.is(u)&&(f=u.toUpperCase(),y=!Pe.includes(f)),u=y?this.safeValue(u):f,l.default="".concat(L.default," ").concat(u)}return!0===o&&(l.autoIncrement=L.autoIncrement),r.Type.string.isNotEmpty(s)&&(l.onUpdate="".concat(L.onUpdate," ").concat(s)),r.Type.string.isNotEmpty(c)&&(c=this.safeValue(c),l.comment="".concat(L.comment," ").concat(c)),v(_e,l)}}]),t}(),at=i;function ut(e,t,r,n,i,a,u){try{var o=e[a](u),s=o.value}catch(e){return void r(e)}o.done?t(s):Promise.resolve(s).then(n,i)}var ot=function(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var a=e.apply(t,r);function u(e){ut(a,n,i,u,o,"next",e)}function o(e){ut(a,n,i,u,o,"throw",e)}u(void 0)}))}},st=b({},{errorConnectConfig:"错误的连接配置",emptyConnectPool:"未连接数据库",errorDialectType:"错误的数据库类型",errorConnect:"错误的连接"}),ct=new n({type:Object,props:[{index:"host",required:!0,type:String,minLength:1},[{index:"port",type:String},{type:Number}],{index:"user",required:!0,type:String,minLength:1},{index:"password",type:String,minLength:1},{index:"database",required:!0,type:String,minLength:1},{index:"dialect",type:String,enum:g},{index:"connectionLimit",type:Number,natural:!0},{index:"connectTimeout",type:Number,natural:!0}]}).verify,lt=function(){function e(t){a(this,e),this.dbConfig={},this.setConfig(t)}return o(e,[{key:"setConfig",value:function(e){if(!ct(e))throw new Error(st.errorConnectConfig);var t=e.host,n=e.user,i=e.password,a=e.port,u=e.database,o=e.connectTimeout,s=e.connectionLimit;s=r.Type.number.isNatural(s)?s:1,this.dbConfig=r.Type.object.pure({host:t,user:n,password:i,port:a,database:u,connectTimeout:o,connectionLimit:s})}},{key:"loadModule",value:function(e){try{return require(e)}catch(t){if(t&&"MODULE_NOT_FOUND"===t.code)throw new Error("请先安装模块 ".concat(e));throw t}}}]),e}(),ft=function(e){function t(e){var r;return a(this,t),(r=f(this,y(t).call(this,e))).pool=r.getPool(),r}return p(t,lt),o(t,[{key:"getPool",value:function(){var e=this.pool,t=this.dbConfig;return r.Type.object.is(e)&&r.Type.func.is(e.getConnection)?e:e=this.loadModule(A.mysql).createPool(t)}},{key:"getDbConnect",value:function(){var e=this.getPool()||{};if(r.Type.func.isNot(e.getConnection))throw new Error(st.emptyConnectPool);return new Promise((function(t,n){e.getConnection((function(e,i){e&&n(e),(!i||r.Type.func.isNot(i.query)||r.Type.func.isNot(i.release))&&n(new Error(st.errorConnect)),t(i)}))}))}}]),t}(),yt=function(e){function t(e){var r;return a(this,t),(r=f(this,y(t).call(this,e))).pool=r.getPool(),r}return p(t,lt),o(t,[{key:"getPool",value:function(){var e=this.pool,t=this.dbConfig;if(r.Type.object.is(e)&&r.Type.func.is(e.acquire))return e;var n={server:t.host,port:t.port,user:t.user,password:t.password,database:t.database,connectionTimeout:t.connectTimeout,pool:{min:1,max:t.connectionLimit||1}};return e=new(this.loadModule(A.mssql).ConnectionPool)(n).connect()}},{key:"getDbConnect",value:function(){var e=this,t=this.getPool()||{};return new Promise(function(){var r=ot(at.mark((function r(n,i){var a;return at.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t;case 2:e.pool=t=r.sent,a=t.request(),n({query:function(e,t){a.query(e,(function(e,r){e&&i(e),t(e,r)}))},release:function(){}});case 7:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}())}}]),t}(),ht=function(){function e(t){a(this,e),this.dialectType=t.dialect||g.mysql,this.connect=this.getConnect(t)}var t;return o(e,[{key:"getConnect",value:function(e){var t;switch(this.dialectType){case g.mysql:t=new ft(e);break;case g.mssql:t=new yt(e)}if(r.Type.undefinedNull.is(t))throw new Error(st.errorDialectType);return t}},{key:"exec",value:(t=ot(at.mark((function e(t){var n,i;return at.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.Type.func.isNot((n=this.connect||{}).getDbConnect)){e.next=3;break}throw new Error(st.emptyConnectPool);case 3:return e.next=5,n.getDbConnect();case 5:return i=e.sent,e.abrupt("return",new Promise((function(e,r){i.query(t,(function(t,n){i.release(),t&&r(t),e(n)}))})));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}(),pt=[T.insert,T.replace,T.select,T.update,T.delete],vt=function(){function e(t,r){a(this,e),this.queryTable="",this.dialectType=t||g.mysql,this.execute=r,this.queryStore=[]}return o(e,[{key:"insert",value:function(){return this.queryInstance(T.insert)}},{key:"select",value:function(){return this.queryInstance(T.select)}},{key:"update",value:function(){return this.queryInstance(T.update)}},{key:"delete",value:function(){return this.queryInstance(T.delete)}},{key:"replace",value:function(){return this.queryInstance(T.replace)}},{key:"create",value:function(){return this.queryInstance(T.create)}},{key:"alter",value:function(){return this.queryInstance(T.alter)}},{key:"queryInstance",value:function(e){var t;switch(e){case T.insert:t=new Ue;break;case T.replace:t=new rt;break;case T.select:t=new $e;break;case T.update:t=new et;break;case T.delete:t=new tt;break;case T.create:t=new nt;break;case T.alter:t=new it}return this.initInstance(e,t)}},{key:"widgetInstance",value:function(e){var t;switch(e){case C.func:t=new Je;break;case C.term:t=new Re;break;case C.order:t=new Me}return this.initInstance(e,t)}},{key:"initInstance",value:function(e,t){t=r.Type.object.safe(t);var n=this.dialectType,i=this.execute,a=this.queryTable;return r.Type.string.isNotEmpty(a)&&r.Type.func.is(t.table)&&pt.includes(e)&&t.table(a),r.Type.func.is(t.setDialect)&&t.setDialect(n),r.Type.func.is(t.checkDialect)&&t.checkDialect(),r.Type.func.is(t.setExecute)&&i&&t.setExecute(i),t}},{key:"table",value:function(e){if(!r.Type.string.isNotEmpty(e))throw new Error(E.errorTableName);return this.queryTable=e,this}},{key:"build",value:function(){throw new Error(E.emptyQueryType)}},{key:"setConnect",value:function(e){if(r.Type.object.isNot(e))return this;e=r.Type.object.safe(e);var t=new ht(e);return this.dialectType=e.dialect||g.mysql,this.execute=t,this}},{key:"getStore",value:function(){return Be.getStore()}},{key:"storeSql",value:function(e){return Be.storeSql(e)}},{key:"isStoreEmpty",value:function(){return Be.isStoreEmpty()}},{key:"cleanStoreSql",value:function(){return Be.cleanStoreSql()}},{key:"func",get:function(){return this.widgetInstance(C.func)}},{key:"term",get:function(){return this.widgetInstance(C.term)}},{key:"order",get:function(){return this.widgetInstance(C.order)}},{key:"query",get:function(){return this.build()}}]),e}();module.exports=function(e){var t;if(r.Type.object.isNot(e))return t=g.mysql,r.Type.string.isNotEmpty(e)&&g[e]&&(t=e),new vt(t);t=e.dialect||g.mysql,e=r.Type.object.safe(e);var n=new ht(e);return new vt(t,n)};
