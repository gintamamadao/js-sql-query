"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("schema-verify"),r=(e=t)&&"object"==typeof e&&"default"in e?e.default:e;function s(e,r){return e.replace(/\{\{([a-zA-Z_0-9]+)\}\}/g,(e,s)=>r.hasOwnProperty(s)&&t.Type.string.isNotEmpty(r[s])?r[s]+" ":"").trim()}function i(e,r){let s=[];return t.Type.array.is(e)?s=e:((r=t.Type.array.safe(r)).unshift(e),s=r),s}const n={errorFuncInfo:"错误的组合函数信息",errorFieldDataArr:"错误的字段数据组",errorInsertValues:"错误的插入值",errorDialect:"错误的数据库类型",errorManualSql:"错误的自定义sql",errorExecute:"缺少或错误的数据库连接",emptySqlQuery:"缺少sql语句",errorPage:"错误的页码",errorSize:"错误的页码",errorStep:"错误的步长",errorOffset:"错误的偏移",errorOrderInfo:"错误的排序信息",errorValueList:"需要非空数组",errorFieldMap:"错误的字段映射",errorTermdata:"错误的条件数据",errorTermSign:"错误的条件类型",errorTermValue:"错误的条件值",errorTermInfo:"错误的条件信息",errorTermBracket:"错误的条件括号信息",errorTermLogic:"错误的条件逻辑",emptyUpdateInfo:"缺少更新信息",errorUpdateInfo:"错误的更新信息",emptyQueryType:"未选择sql类型",errorCreateDbName:"错误的数据库名",errorAlterField:"错误的修改配置",emptyAlterInfos:"空的修改配置",tableFieldsError:"错误的表字段名",tableFieldsAsMapError:"错误的表字段映射名",joinTableInfoError:"错误的联查信息",errorTableName:"错误的表名，需要非空字符串",errorField:"错误的表名，需要非空字符串",errorFields:"错误的字段，需要非空字符串或非空字符串数组",errorFieldData:"错误的字段数据",needStr:"需要字符串",needNumStr:"需要数字或者字符串",notSupportDialect:"无法支持当前类型数据库",errorTermStatus:"未设置条件类型"},o={mysql:{safeValue(e){let r="";if("string"==typeof e&&(r=`'${e=e.replace(/\'/g,()=>"''").replace(/\\/g,()=>"\\\\")}'`),t.Type.number.is(e)&&(r=`'${e}'`),!r)throw new Error(n.needNumStr);return r},safeKey(e){let r;if(!t.Type.string.isNotEmpty(e))throw new Error(n.needStr);return r=e.replace(/`/g,"``"),"`"+r+"`"}},mssql:{safeValue(e){let r="";if("string"==typeof e&&(r=`'${e=e.replace(/\'/g,()=>"''")}'`),t.Type.number.is(e)&&(r=`'${e}'`),!r)throw new Error(n.needNumStr);return r},safeKey(e){if(!t.Type.string.isNotEmpty(e))throw new Error(n.needStr);return`[${e}]`}},postgresql:{safeValue(e){let r="";if("string"==typeof e&&(r=`'${e=e.replace(/\'/g,()=>"''")}'`),t.Type.number.is(e)&&(r=`'${e}'`),!r)throw new Error(n.needNumStr);return r},safeKey(e){let r;if(!t.Type.string.isNotEmpty(e))throw new Error(n.needStr);return r=e.replace(/\"/g,'""'),`"${r}"`}},sqlite:{safeValue(e){let r="";if("string"==typeof e&&(r=`'${e=e.replace(/\'/g,()=>"''")}'`),t.Type.number.is(e)&&(r=`'${e}'`),!r)throw new Error(n.needNumStr);return r},safeKey(e){let r;if(!t.Type.string.isNotEmpty(e))throw new Error(n.needStr);return r=e.replace(/`/g,"``"),"`"+r+"`"}}};var a,u,h,c;!function(e){e.mysql="mysql",e.mssql="mssql",e.postgresql="postgresql",e.sqlite="sqlite"}(a||(a={})),function(e){e.insert="INSERT",e.replace="REPLACE",e.select="SELECT",e.update="UPDATE",e.delete="DELETE",e.create="CREATE",e.alter="ALTER"}(u||(u={})),function(e){e.count="COUNT",e.sum="SUM",e.max="MAX",e.min="MIN",e.avg="AVG",e.abs="ABS",e.ceil="CEIL",e.floor="FLOOR",e.round="ROUND",e.log="LOG",e.log2="LOG2",e.exp="EXP",e.power="POWER",e.acos="ACOS",e.asin="ASIN",e.atan="ATAN",e.cos="COS",e.sin="SIN",e.tan="TAN",e.conv="CONV",e.random="RANDOM",e.rand="RAND",e.radians="RADIANS",e.degrees="DEGREES",e.distinct="DISTINCT"}(h||(h={})),function(e){e.and="AND",e.or="OR"}(c||(c={}));const l={and:"AND",or:"OR"};var p;!function(e){e.equal="=",e.notEqual="<>",e.more=">",e.less="<",e.moreEqual=">=",e.lessEqual="<=",e.like="LIKE",e.notlike="NOT LIKE",e.isNot="IS NOT",e.in="IN",e.notIn="NOT IN",e.between="BETWEEN",e.notBetween="NOT BETWEEN"}(p||(p={}));const y={equal:"=",notEqual:"<>",more:">",less:"<",moreEqual:">=",lessEqual:"<=",like:"LIKE",notlike:"NOT LIKE",isNot:"IS NOT",in:"IN",notIn:"NOT IN",between:"BETWEEN",notBetween:"NOT BETWEEN"};var f,d,m,g,T,w,E,b,N;!function(e){e.desc="DESC",e.asc="ASC",e.field="FIELD"}(f||(f={})),function(e){e.set="SET",e.add="ADD",e.minus="MINUS"}(d||(d={})),function(e){e.func="FUNC",e.term="TERM",e.order="ORDER"}(m||(m={})),function(e){e.tinyint="TINYINT",e.smallint="SMALLINT",e.mediumint="MEDIUMINT",e.int="INT",e.bigint="BIGINT",e.float="FLOAT",e.double="DOUBLE",e.decimal="DECIMAL",e.date="DATE",e.time="TIME",e.year="YEAR",e.datetime="DATETIME",e.timestamp="TIMESTAMP",e.char="CHAR",e.varchar="VARCHAR",e.tinyblob="TINYBLOB",e.tinytest="TINYTEXT",e.blob="BLOB",e.test="TEXT",e.mediumblob="MEDIUMBLOB",e.mediumtext="MEDIUMTEXT",e.longblob="LONGBLOB",e.longtext="LONGTEXT"}(g||(g={})),function(e){e.primaryKey="PRIMARY KEY",e.uniqueKey="UNIQUE KEY",e.engine="ENGINE",e.autoIncrement="AUTO_INCREMENT",e.defaultCharset="DEFAULT CHARSET",e.comment="COMMENT",e.unsigned="UNSIGNED",e.notNull="NOT NULL",e.default="DEFAULT",e.onUpdate="ON UPDATE",e.constraint="CONSTRAINT"}(T||(T={})),function(e){e.add="ADD",e.drop="DROP",e.modify="MODIFY",e.change="CHANGE"}(w||(w={})),function(e){e.inner="INNER",e.left="LEFT",e.right="RIGHT"}(E||(E={})),function(e){e.where="whereTerm",e.having="havingTerm"}(b||(b={})),function(e){e.mysql="mysql",e.mssql="mssql"}(N||(N={}));const q=new r({type:Array,elements:{type:Object,required:!0,props:[[{type:String},{type:Number}]]}}).verify,S=new r({type:Object,restrict:!0,props:[{index:"funcFeild",required:!0,type:String}]}),O=new r({type:Object,restrict:!0,props:[{type:String,index:"func",required:!0,custom:e=>!!h[e]},[{index:"field",required:!0,type:String},{type:Number}]]}),I=S.verify,C=O.verify,F=new r({type:Object,restrict:!0,props:[{index:"safeKey",required:!0,type:Function},{index:"safeValue",required:!0,type:Function}]}),L=new r([{type:String,minLength:1},{type:Function},{type:Object}]),v=F.verify,B=L.verify,$=new r({type:Number,integer:!0,min:1}),j=new r({type:Object,restrict:!0,props:[{type:Number,index:"offset",integer:!0,required:!0},{type:Number,index:"step",integer:!0,required:!0}]}),x=$.verify,k=j.verify,A=new r({type:Object,restrict:!0,props:[{index:"field",required:!0,type:String},{index:"type",required:!0,type:String,enum:f},{index:"list",type:Array,elements:[[{type:String,required:!0,minLength:1},{type:Number}]]}]}),M=new r({type:Array,elements:[[{type:String,required:!0,minLength:1},{type:Number}]]}),D=A.verify,K=M.verify,U=new r({type:Object,props:[[{required:!0,type:String},{type:Number},{type:Array,minLength:1,elements:[[{type:String,required:!0},{type:Number}]]}]]}),V=new r({type:String,enum:Object.keys(y).map(e=>y[e])}),R=new r({type:String,enum:Object.keys(l).map(e=>l[e])}),_=new r([{required:!0,type:String},{type:Number}]),P=new r({type:Array,minLength:1,elements:[[{type:String,required:!0},{type:Number}]]}),G=new r({type:Array,length:2,elements:[[{type:String,required:!0},{type:Number}]]}),H=new r({type:Object,restrict:!0,props:[{index:"position",required:!0,type:Number,min:1},{index:"logic",required:!0,type:String,enum:Object.keys(l).map(e=>l[e])}]}),Q=new r({type:Object,restrict:!0,props:[{index:"field",required:!0,type:String,minLength:1},[{index:"value",required:!0,type:String},{type:Number},{type:Array,minLength:1,elements:[[{type:String,required:!0},{type:Number}]]}],{index:"sign",required:!0,type:String,enum:Object.keys(y).map(e=>y[e])},{index:"logic",required:!0,type:String,enum:Object.keys(l).map(e=>l[e])}]}),W=U.verify,Y=V.verify,X=R.verify,J=_.verify,z=P.verify,Z=G.verify,ee=H.verify,te=Q.verify,re=new r({type:Object,props:[[{index:"value",required:!0,type:String},{type:Number}],{index:"type",required:!0,type:String,enum:d}]}).verify,se=new r({type:Object,props:[{index:"field",required:!0,type:String,minLength:1},{index:"type",required:!0,type:String,minLength:1},{index:"unsigned",type:Boolean},{index:"autoIncrement",type:Boolean},{index:"notNull",type:Boolean},[{index:"default",type:String},{type:Number}],{index:"onUpdate",type:String},{index:"comment",type:String}]}),ie=new r({type:Object,props:[{index:"keyName",required:!0,type:String,minLength:1},{index:"combineFields",required:!0,type:Array,minLength:1,elements:{type:String,minLength:1}}]}),ne=new r({type:Object,props:[{index:"tableName",required:!0,type:String,minLength:1},[{index:"primaryKey",required:!0,type:String,minLength:1},ie],[{index:"uniqueKey",type:String,minLength:1},ie],{index:"engine",type:String},{index:"defaultCharset",type:String},{index:"comment",type:String},{index:"autoIncrement",type:Number},{index:"fields",type:Array,minLength:1,elements:se}]}).verify,oe=new r({type:Object,props:[{index:"field",type:String,minLength:1},{index:"type",type:String,minLength:1},{index:"unsigned",type:Boolean},{index:"autoIncrement",type:Boolean},{index:"notNull",type:Boolean},[{index:"default",type:String},{type:Number}],{index:"onUpdate",type:String},{index:"comment",type:String}]}),ae=new r({type:Object,props:[{index:"method",required:!0,type:String,enum:w},{index:"field",required:!0,type:String,minLength:1},{index:"alterField",required:!0,schema:oe}]}).verify,ue=new r({type:Object,props:{type:Array,elements:{type:String,required:!0,minLength:1}}}),he=new r({type:Object,props:{type:Object,props:{type:String,required:!0,minLength:1}}}),ce=new r({type:Object,props:{tableName:{type:String,required:!0,minLength:1},termInfos:{type:Array,required:!0,elements:{type:Object,props:{symbol:{type:String,required:!0,minLength:1,enum:Object.keys(y).map(e=>y[e])},tableFields:{type:Object,props:{type:String,required:!0,minLength:1}}}}}}}),le=ue.verify,pe=he.verify,ye=ce.verify,fe=new r({type:Array,elements:{type:String,required:!0,minLength:1}}).verify,de=new r({type:Object,props:{type:String,required:!0,minLength:1}}).verify,me=new r({type:Number,natural:!0}).verify,ge=new r({type:Number,integer:!0}).verify,Te=new r({type:Object,props:[[{required:!0,type:String},{type:Number}]]}).verify;let we=[];var Ee=new class{getStore(){return we.slice()}storeSql(e){t.Type.string.isNotEmpty(e)&&we.push(e)}isStoreEmpty(){return!(we.length>0)}cleanStoreSql(){we=[]}};class be{constructor(){this._queryTable="",this._dialect={},this._dialectType="",this._execute={},this._safeValue=()=>"",this._safeKey=()=>"",this.safeValue=function(e){let t;switch(this._dialectType){case a.mysql:t=this.loadModule(N.mysql),e=t.escape(e);break;default:e=this._safeValue(e)}return e+""},this.safeKey=function(e){return this._safeKey(e)}}get dialectType(){const e=this._dialectType;if(!v(o[e]))throw new Error(n.errorDialect);return e}set dialectType(e){this.setDialect(e)}setDialect(e){if(!v(o[e]))throw new Error(n.errorDialect);const t=o[e];this._dialect=t,this._dialectType=e,this._safeValue=t.safeValue,this._safeKey=t.safeKey}loadModule(e){try{return require(e)}catch(t){if(t&&"MODULE_NOT_FOUND"===t.code)throw new Error("请先安装模块 "+e);throw t}}manualSql(e,t){if(!(B(e)||e instanceof be))throw new Error(n.errorManualSql);this[t]=e}formatManualSql(e){let r=this[e];return t.Type.string.is(r)||t.Type.func.is(r)&&(r=r(),t.Type.string.is(r))||t.Type.object.isNotEmpty(r)&&r instanceof be&&(r=r.query,t.Type.string.is(r))?r:""}build(){return""}get query(){return this.build()}table(e){if(!t.Type.string.isNotEmpty(e))throw new Error(n.errorTableName);return this._queryTable=e,this}getQueryTable(){const e=this._queryTable;if(!t.Type.string.isNotEmpty(e))throw new Error(n.errorTableName);return this.safeKey(e)}storeSql(){let e;try{e=this.build()}catch(e){}return t.Type.string.isNotEmpty(e)&&Ee.storeSql(e),this}setExecute(e){this._execute=e}exec(e){const r=this._execute,s=t.Type.string.isNotEmpty(e)?e:this.build();if(!t.Type.string.isNotEmpty(s))throw new Error(n.emptySqlQuery);if(t.Type.object.isNot(r)||t.Type.func.isNot(r.exec))throw new Error(n.errorExecute);return r.exec(s||"")}execAll(e){const r=this._execute;if(e=t.Type.array.isNotEmpty(e=e||[])?e:Ee.getStore(),t.Type.object.isNot(r)||t.Type.func.isNot(r.exec))throw new Error(n.errorExecute);const s=[];for(let i of e)t.Type.string.isNotEmpty(i)&&s.push(r.exec(i));return Promise.all(s)}}class Ne{constructor(){this.limitInfo={}}limitBuild(e){const t=this.limitInfo;if(!k(t))return e;const r=t.offset,s=t.step;return 0===r?`${e} LIMIT ${s}`:-1===s?`${e} OFFSET ${r}`:`${e} LIMIT ${s} OFFSET ${r}`}limit(e,r){if(!ge(e))throw new Error(n.errorOffset);if(t.Type.undefined.isNot(r)&&!ge(r))throw new Error(n.errorStep);let s={};t.Type.number.is(e)&&t.Type.number.is(r)&&(s={offset:e,step:r=r||0}),t.Type.number.is(e)&&!t.Type.number.is(r)&&(s={offset:0,step:e}),this.limitInfo=s}offset(e){if(!ge(e))throw new Error(n.errorOffset);this.limitInfo={offset:e,step:-1}}step(e){if(!ge(e))throw new Error(n.errorStep);this.limitInfo={offset:0,step:e}}paging(e,t){if(!x(e))throw new Error(n.errorPage);if(!me(t))throw new Error(n.errorSize);this.limitInfo={offset:(e-1)*t,step:t}}}class qe extends be{constructor(){super(),this.orderSql="",this.orderInfos=[]}build(){const e=this.formatOrderSql();if(t.Type.string.isNotEmpty(e))return e;const r=t.Type.array.safe(this.orderInfos);if(!t.Type.array.isNotEmpty(r))return"";let s=[];for(const e of r){if(!D(e))continue;const t=e.type,r=e.list,i=this.safeKey(e.field);if(t!==f.field)s.push(`${i} ${t}`);else{const e=(r||[]).map(e=>this.safeValue(e)).join(", ");s.push(`${t}(${i}, ${e})`)}}return t.Type.array.isNotEmpty(s)?(s=Array.from(new Set(s)),s.join(", ")):""}orderBuild(e){const r=this.build();return t.Type.string.isNotEmpty(r)&&(e=`${e} ORDER BY ${r}`),e}descBy(e,t){const r=i(e,t);return this.orderCache(r,f.desc)}ascBy(e,t){const r=i(e,t);return this.orderCache(r,f.asc)}orderField(e){e=t.Type.object.safe(e);const r=Object.keys(e);return this.orderCache(r,f.field,e)}order(e){this.manualSql(e,"orderSql")}formatOrderSql(){return this.formatManualSql("orderSql")}orderCache(e,r,s){if(!fe(e))throw new Error(n.errorFields);s=t.Type.object.safe(s);const i=t.Type.array.safe(this.orderInfos);for(const t of e){const e={field:t,type:r};if(r===f.field){const r=s[t];if(!K(r))throw new Error(n.errorValueList);e.list=r}if(!D(e))throw new Error(n.errorOrderInfo);i.push(e)}return this.orderInfos=i,this}}class Se extends be{constructor(){super(...arguments),this.queryLimit={},this.queryOrder={}}getLimitCase(){let e=this.queryLimit;return e&&e instanceof Ne||(e=new Ne,this.queryLimit=e),e}limitBuild(e){return this.getLimitCase().limitBuild(e)}offset(e){return this.getLimitCase().offset(e),this}step(e){return this.getLimitCase().step(e),this}getOrderCase(){let e=this.queryOrder;return e&&e instanceof qe||(e=new qe,e.setDialect(this.dialectType),this.queryOrder=e),e}orderBuild(e){return this.getOrderCase().orderBuild(e)}descBy(e,...t){return this.getOrderCase().descBy(e,t),this}ascBy(e,...t){return this.getOrderCase().ascBy(e,t),this}orderField(e){return this.getOrderCase().orderField(e),this}order(e){return this.getOrderCase().order(e),this}}class Oe extends Se{constructor(){super(),this.valuesSql="",this.queryType=u.insert,this.insertData={},this.insertFields=[],this.insertDataArr=[]}data(e){if(!Te(e))throw new Error(n.errorFieldData);const r=t.Type.object.safe(this.insertData);return this.insertData=Object.assign({},r,e),this}fields(e,...r){const s=i(e,r),n=t.Type.array.safe(this.insertFields),o=[].concat(n,s);return this.insertFields=Array.from(new Set(o)),this}multiData(e){if(!q(e))throw new Error(n.errorFieldDataArr);const r=t.Type.array.safe(this.insertDataArr);return this.insertDataArr=[].concat(r,e),this}values(e){return this.manualSql(e,"valuesSql"),this}formatValuesSql(){return this.formatManualSql("valuesSql")}formatFields(){const e=this.insertData,t=this.insertFields,r=this.insertDataArr;let s=[];if(fe(t)?s=t:Te(e)?s=Object.keys(e):q(r)&&(s=Object.keys(r[0])),!fe(s))throw new Error(n.errorFields);return s}formatValues(e){e=t.Type.array.safe(e);let r="";const s=this.formatValuesSql(),i=this.insertData,o=this.insertDataArr,a=[],u=t=>`( ${e.map(e=>this.safeValue(t[e])).join(", ")} )`;if(t.Type.string.isNotEmpty(s)?r=s:Te(i)?r=u(i):q(o)&&(r=(e=>{for(const r of e)t.Type.object.isNotEmpty(r)&&a.push(u(r));return a.join(", ")})(o)),!t.Type.string.isNotEmpty(r))throw new Error(n.errorInsertValues);return"VALUES "+r}build(){const e=this.queryType,t=this.getQueryTable(),r=this.formatFields(),s=this.formatValues(r);return`${e} INTO ${t} ( ${r.map(e=>this.safeKey(e)).join(", ")} )  ${s}`}}class Ie extends be{constructor(){super(),this.termSql="",this.termInfos=[],this.termBrackets=[]}build(){return this.termsBuild()}termsBuild(){const e=this.formatTermSql();if(t.Type.string.isNotEmpty(e))return e;const r=this.termInfos,s=this.termBrackets;return t.Type.array.isNotEmpty(r)?t.Type.array.isNotEmpty(s)?this.formatTermBrackets(s,r):this.formatTerms(r):""}formatTermSql(){return this.formatManualSql("termSql")}formatTermBrackets(e,r){let s="";e=t.Type.array.safe(e),r=t.Type.array.safe(r);const i=e.length,o=r.length;for(let a=0;i>a;a++){const u=e[a],h=e[a-1],c=e[a+1];if(!ee(u))throw new Error(n.errorTermBracket);const l=u.position,p=u.logic;let y=0,f=o;ee(h)&&(y=h.position),ee(c)&&(f=c.position);const d=r.slice(y,l),m=r.slice(l,f),g=this.formatBracketTerm(1===i||a+1===i||f===o,p,d,m);t.Type.string.isNotEmpty(g)&&(s=t.Type.string.isNotEmpty(s)?`${s} ${g}`:g)}return s}formatBracketTerm(e,r,s,i){s=t.Type.array.safe(s),i=t.Type.array.safe(i);const n=this.formatTerms(s);if(0>=s.length||0>=i.length)return"";if(e){return`( ${n} ) ${r} ( ${this.formatTerms(i)} )`}return`( ${n} ) ${r}`}formatTerms(e){e=t.Type.array.safe(e);let r="";for(const s of e){if(!te(s))throw new Error(n.errorTermInfo);const e=this.safeKey(s.field),i=s.sign,o=s.logic,a=`${e} ${i} ${this.formatTermValue(s.value,i)}`;t.Type.string.isNotEmpty(r)?r=`${r} ${o} ${a}`:r=a}return r}formatTermValue(e,t){let r;if(t===p.in||t===p.notIn){if(!z(e))throw new Error(n.errorTermValue);return r=e.map(e=>this.safeValue(e)).join(", "),`( ${r} )`}if(t===p.between||t===p.notBetween){if(!Z(e))throw new Error(n.errorTermValue);return`${this.safeValue(e[0])} AND ${this.safeValue(e[1])}`}if(!J(e))throw new Error(n.errorTermValue);return t!==p.like&&t!==p.notlike||(e=`%${e}%`),r=this.safeValue(e),r}termCache(e,r,s){if(!W(e))throw new Error(n.errorTermdata);if(!Y(r))throw new Error(n.errorTermSign);if(!X(s))throw new Error(n.errorTermLogic);const i=t.Type.array.safe(this.termInfos),o=[];for(const t of Object.keys(e)){const i=e[t];switch(r){case p.in:case p.notIn:if(!z(i))throw new Error(n.errorTermValue);break;case p.between:case p.notBetween:if(!Z(i))throw new Error(n.errorTermValue);break;default:if(!J(i))throw new Error(n.errorTermValue)}o.push({field:t,value:i,sign:r,logic:s})}return this.termInfos=[].concat(i,o),this}bracketTerm(e){const r=t.Type.array.safe(this.termInfos),s=t.Type.array.safe(this.termBrackets),i=r.length;if(0>=i)return this;for(const e of s){if(!ee(e))continue;if(e.position===i)return this}const n={position:i,logic:e};return ee(n)&&s.push(n),this.termBrackets=s,this}sqlTerm(e){this.manualSql(e,"termSql")}equal(e){return this.and(e,p.equal)}notEqual(e){return this.and(e,p.notEqual)}in(e){return this.and(e,p.in)}notIn(e){return this.and(e,p.notIn)}more(e){return this.and(e,p.more)}less(e){return this.and(e,p.less)}moreEqual(e){return this.and(e,p.moreEqual)}lessEqual(e){return this.and(e,p.lessEqual)}like(e){return this.and(e,p.like)}notLike(e){return this.and(e,p.notlike)}between(e){return this.and(e,p.between)}notBetween(e){return this.and(e,p.notBetween)}orEqual(e){return this.or(e,p.equal)}orNotEqual(e){return this.or(e,p.notEqual)}orIn(e){return this.or(e,p.in)}orNotIn(e){return this.or(e,p.notIn)}orMore(e){return this.or(e,p.more)}orLess(e){return this.or(e,p.less)}orMoreEqual(e){return this.or(e,p.moreEqual)}orLessEqual(e){return this.or(e,p.lessEqual)}orLike(e){return this.or(e,p.like)}orBetween(e){return this.or(e,p.between)}orNotBetween(e){return this.or(e,p.notBetween)}orNotLike(e){return this.or(e,p.notlike)}bracket(){return this.bracketTerm(c.and)}orBracket(){return this.bracketTerm(c.or)}and(e,t){return this.termCache(e,t,c.and)}or(e,t){return this.termCache(e,t,c.or)}}const Ce=["CURRENT_TIMESTAMP"],Fe="{{field}}{{type}}{{unsigned}}{{notNull}}{{default}}{{autoIncrement}}{{onUpdate}}{{comment}}",Le={equal:"whereEqual",notEqual:"whereNotEqual",in:"whereIn",notIn:"whereNotIn",more:"whereMore",less:"whereLess",moreEqual:"whereMoreEqual",lessEqual:"whereLessEqual",like:"whereLike",notLike:"whereNotLike",between:"whereBetween",notBetween:"whereNotBetween",orEqual:"whereOrEqual",orNotEqual:"whereOrNotEqual",orIn:"whereOrIn",orNotIn:"whereOrNotIn",orMore:"whereOrMore",orLess:"whereOrLess",orMoreEqual:"whereOrMoreEqual",orLessEqual:"whereOrLessEqual",orLike:"whereOrLike",orNotLike:"whereOrNotLike",orBetween:"whereOrBetween",orNotBetween:"whereOrNotBetween"},ve={equal:"havingEqual",notEqual:"havingNotEqual",in:"havingIn",notIn:"havingNotIn",more:"havingMore",less:"havingLess",moreEqual:"havingMoreEqual",lessEqual:"havingLessEqual",like:"havingLike",notLike:"havingNotLike",between:"havingBetween",notBetween:"havingNotBetween",orEqual:"havingOrEqual",orNotEqual:"havingOrNotEqual",orIn:"havingOrIn",orNotIn:"havingOrNotIn",orMore:"havingOrMore",orLess:"havingOrLess",orMoreEqual:"havingOrMoreEqual",orLessEqual:"havingOrLessEqual",orLike:"havingOrLike",orNotLike:"havingOrNotLike",orBetween:"havingOrBetween",orNotBetween:"havingOrNotBetween"},Be=Object.values(b);class $e extends Se{constructor(){super(),this.termStatus="",this.equal=e=>this,this.notEqual=e=>this,this.in=e=>this,this.notIn=e=>this,this.more=e=>this,this.less=e=>this,this.moreEqual=e=>this,this.lessEqual=e=>this,this.like=e=>this,this.notLike=e=>this,this.between=e=>this,this.notBetween=e=>this,this.orEqual=e=>this,this.orNotEqual=e=>this,this.orIn=e=>this,this.orNotIn=e=>this,this.orMore=e=>this,this.orLess=e=>this,this.orMoreEqual=e=>this,this.orLessEqual=e=>this,this.orLike=e=>this,this.orNotLike=e=>this,this.orBetween=e=>this,this.orNotBetween=e=>this;for(const e of Object.keys(Le))this[e]=function(t){return this.termApiFn(e,t)}}termApiFn(e,t){const r=this.termStatus;if(!Be.includes(r))throw new Error(n.errorTermStatus);return this.getTermCase(r)[e](t),this}bracket(){const e=this.termStatus;if(!Be.includes(e))throw new Error(n.errorTermStatus);return this.getTermCase(e).bracket(),this}orBracket(){const e=this.termStatus;if(!Be.includes(e))throw new Error(n.errorTermStatus);return this.getTermCase(e).orBracket(),this}getTermCase(e){let t=this[e];return t&&t instanceof Ie||(t=new Ie,t.setDialect(this.dialectType),this[e]=t),t}}class je extends $e{constructor(){super(),this.whereTerm={},this.whereEqual=e=>this,this.whereNotEqual=e=>this,this.whereIn=e=>this,this.whereNotIn=e=>this,this.whereMore=e=>this,this.whereLess=e=>this,this.whereMoreEqual=e=>this,this.whereLessEqual=e=>this,this.whereLike=e=>this,this.whereNotLike=e=>this,this.whereBetween=e=>this,this.whereNotBetween=e=>this,this.whereOrEqual=e=>this,this.whereOrNotEqual=e=>this,this.whereOrIn=e=>this,this.whereOrNotIn=e=>this,this.whereOrMore=e=>this,this.whereOrLess=e=>this,this.whereOrMoreEqual=e=>this,this.whereOrLessEqual=e=>this,this.whereOrLike=e=>this,this.whereOrNotLike=e=>this,this.whereOrBetween=e=>this,this.whereOrNotBetween=e=>this;for(const e of Object.keys(Le)){this[Le[e]]=function(t){return this.whereTermApiFn(e,t)}}}whereTermApiFn(e,t){return this.getWhereTermCase()[e](t),this}whereBracket(){return this.getWhereTermCase().bracket(),this}whereOrBracket(){return this.getWhereTermCase().orBracket(),this}where(e){if(t.Type.undefined.isNot(e)){const r=this.getWhereTermCase();t.Type.func.is(e)&&(e=e.bind(this,r)),r.sqlTerm(e)}else this.termStatus=b.where;return this}getWhereTermCase(){return this.getTermCase(b.where)}whereBuild(e){const r=this.getWhereTermCase().termsBuild();return t.Type.string.isNotEmpty(r)&&(e=`${e} WHERE ${r}`),e}}class xe extends je{constructor(){super(),this.havingTerm={},this.havingEqual=e=>this,this.havingNotEqual=e=>this,this.havingIn=e=>this,this.havingNotIn=e=>this,this.havingMore=e=>this,this.havingLess=e=>this,this.havingMoreEqual=e=>this,this.havingLessEqual=e=>this,this.havingLike=e=>this,this.havingNotLike=e=>this,this.havingBetween=e=>this,this.havingNotBetween=e=>this,this.havingOrEqual=e=>this,this.havingOrNotEqual=e=>this,this.havingOrIn=e=>this,this.havingOrNotIn=e=>this,this.havingOrMore=e=>this,this.havingOrLess=e=>this,this.havingOrMoreEqual=e=>this,this.havingOrLessEqual=e=>this,this.havingOrLike=e=>this,this.havingOrNotLike=e=>this,this.havingOrBetween=e=>this,this.havingOrNotBetween=e=>this;for(const e of Object.keys(ve)){this[ve[e]]=function(t){return this.havingTermApiFn(e,t)}}}havingTermApiFn(e,t){return this.getHavingTermCase()[e](t),this}havingBracket(){return this.getHavingTermCase().bracket(),this}havingOrBracket(){return this.getHavingTermCase().orBracket(),this}having(e){if(t.Type.undefined.isNot(e)){const r=this.getHavingTermCase();t.Type.func.is(e)&&(e=e.bind(this,r)),r.sqlTerm(e)}else this.termStatus=b.having;return this}getHavingTermCase(){return this.getTermCase(b.having)}havingBuild(e){const r=this.getHavingTermCase().termsBuild();return t.Type.string.isNotEmpty(r)&&(e=`${e} HAVING ${r}`),e}}class ke extends be{funcField(e,r){const s=t.Type.string.isNotEmpty(r)&&"*"!==r,i=s?r:t.Type.number.is(r)?r+"":"*";return{funcFeild:`${e}(${s?this.safeKey(i):i})`}}count(e){return this.funcField(h.count,e)}sum(e){return this.funcField(h.sum,e)}max(e){return this.funcField(h.max,e)}min(e){return this.funcField(h.min,e)}avg(e){return this.funcField(h.avg,e)}abs(e){return this.funcField(h.abs,e)}ceil(e){return this.funcField(h.ceil,e)}floor(e){return this.funcField(h.floor,e)}round(e){return this.funcField(h.round,e)}log(e){return this.funcField(h.log,e)}log2(e){return this.funcField(h.log2,e)}exp(e){return this.funcField(h.exp,e)}power(e){return this.funcField(h.power,e)}acos(e){return this.funcField(h.acos,e)}asin(e){return this.funcField(h.asin,e)}atan(e){return this.funcField(h.atan,e)}cos(e){return this.funcField(h.cos,e)}sin(e){return this.funcField(h.sin,e)}tan(e){return this.funcField(h.tan,e)}conv(e){return this.funcField(h.conv,e)}random(e){return this.funcField(h.random,e)}rand(e){return this.funcField(h.rand,e)}radians(e){return this.funcField(h.radians,e)}degrees(e){return this.funcField(h.degrees,e)}distinct(e){return this.funcField(h.distinct,e)}}class Ae extends xe{constructor(){super(),this.funcInstance={},this.groupByFields=[],this.combineFuncs=[]}groupBuild(e){const r=this.groupByFields;if(!t.Type.array.isNotEmpty(r))return e;return e=`${e} GROUP BY ${r.map(e=>this.safeKey(e)).join(", ")}`}groupBy(...e){let r=t.Type.array.safe(this.groupByFields);if(!fe(e))throw new Error(n.errorFields);return r=r.concat(e),this.groupByFields=Array.from(new Set(r)),this}getFuncCase(){let e=this.funcInstance;return e&&e instanceof ke||(e=new ke,e.setDialect(this.dialectType),this.funcInstance=e),e}formatFuncs(){const e=t.Type.array.safe(this.combineFuncs);let r=[];for(const t of e){if(!I(t))throw new Error(n.errorFuncInfo);r.push(t.funcFeild)}return r=Array.from(new Set(r)),r}funcsCache(e){const r=t.Type.array.safe(this.combineFuncs);return I(e)&&r.push(e),this.combineFuncs=r,this}funcFeilds(...e){for(let r of e){if(r=t.Type.object.safe(r),I(r)){this.funcsCache(r);continue}const e=this.getFuncCase();if(C(r)){const s=r.func,i=r.field;if(t.Type.object.is(e)&&t.Type.func.is(e[s])){const t=e[s].call(e,i);this.funcsCache(t)}}else;}return this}count(e){const t=this.getFuncCase().count(e);return this.funcsCache(t)}sum(e){const t=this.getFuncCase().sum(e);return this.funcsCache(t)}max(e){const t=this.getFuncCase().max(e);return this.funcsCache(t)}min(e){const t=this.getFuncCase().min(e);return this.funcsCache(t)}avg(e){const t=this.getFuncCase().avg(e);return this.funcsCache(t)}abs(e){const t=this.getFuncCase().abs(e);return this.funcsCache(t)}ceil(e){const t=this.getFuncCase().ceil(e);return this.funcsCache(t)}floor(e){const t=this.getFuncCase().floor(e);return this.funcsCache(t)}round(e){const t=this.getFuncCase().round(e);return this.funcsCache(t)}log(e){const t=this.getFuncCase().log(e);return this.funcsCache(t)}log2(e){const t=this.getFuncCase().log2(e);return this.funcsCache(t)}exp(e){const t=this.getFuncCase().exp(e);return this.funcsCache(t)}power(e){const t=this.getFuncCase().power(e);return this.funcsCache(t)}acos(e){const t=this.getFuncCase().acos(e);return this.funcsCache(t)}asin(e){const t=this.getFuncCase().asin(e);return this.funcsCache(t)}atan(e){const t=this.getFuncCase().atan(e);return this.funcsCache(t)}cos(e){const t=this.getFuncCase().cos(e);return this.funcsCache(t)}sin(e){const t=this.getFuncCase().sin(e);return this.funcsCache(t)}tan(e){const t=this.getFuncCase().tan(e);return this.funcsCache(t)}conv(e){const t=this.getFuncCase().conv(e);return this.funcsCache(t)}random(e){const t=this.getFuncCase().random(e);return this.funcsCache(t)}rand(e){const t=this.getFuncCase().rand(e);return this.funcsCache(t)}radians(e){const t=this.getFuncCase().radians(e);return this.funcsCache(t)}degrees(e){const t=this.getFuncCase().degrees(e);return this.funcsCache(t)}distinct(e){const t=this.getFuncCase().distinct(e);return this.funcsCache(t)}}class Me extends Ae{constructor(){super(),this.queryTables=[],this.tableFieldsMap={},this.tableFieldsAsMap={},this.joinTypeInfos=[]}getQueryTables(){return t.Type.array.safe(this.queryTables).map(e=>this.safeKey(e)).join(", ")}formatJoinFields(){const e=t.Type.object.safe(this.tableFieldsMap),r=t.Type.object.safe(this.tableFieldsAsMap),s=[];for(const i of Object.keys(e)){const n=t.Type.array.safe(e[i]),o=t.Type.object.safe(r[i]),a=this.safeKey(i);for(const e of n){if(!t.Type.string.isNotEmpty(e))continue;const r=`${a}.${this.safeKey(e)}`;if(t.Type.string.isNotEmpty(o[e])){const t=this.safeKey(o[e]);s.push(`${r} AS ${t}`)}else s.push(r)}}return s}joinBuild(e){const r=t.Type.array.safe(this.joinTypeInfos);if(!t.Type.array.isNotEmpty(r))return e;const s=[];for(const e of r){const r=e.type,i=t.Type.object.safe(e.info),n=i.tableName,o=t.Type.array.safe(i.termInfos),a=this.joinTermBuild(o);let u=`${r} JOIN ${this.safeKey(n)}`;if(t.Type.array.isNotEmpty(a)){u+=" ON "+a.join(" AND ")}s.push(u)}if(!t.Type.array.isNotEmpty(s))return e;return e=`${e} ${s.join(" ")}`}joinTermBuild(e){const r=[];for(const s of e){const e=s.symbol,i=s.tableFields;let n="";for(const r of Object.keys(i)){const s=i[r],o=this.safeKey(r),a=this.safeKey(s);t.Type.string.isNotEmpty(n)&&(n+=` ${e} `),n+=`${o}.${a}`}r.push(`(${n})`)}return r}multiTables(e,...r){const s=t.Type.array.safe(this.queryTables),n=i(e,r),o=[];for(const e of n)t.Type.string.isNotEmpty(e)&&o.push(e);return this.queryTables=Array.from(new Set(s.concat(o))),this}tableFields(e){const r=t.Type.object.safe(this.tableFieldsMap);if(!le(e))throw new Error(n.tableFieldsError);return this.tableFieldsMap=Object.assign({},r,e),this}tableAsMap(e){const r=t.Type.object.safe(this.tableFieldsAsMap);if(!pe(e))throw new Error(n.tableFieldsAsMapError);return this.tableFieldsAsMap=Object.assign({},r,e),this}join(e,r){const s=t.Type.array.safe(this.joinTypeInfos);if(!ye(e))throw new Error(n.joinTableInfoError);return s.push({type:r,info:e}),this.joinTypeInfos=s,this}innerJoin(e){return this.join(e,E.inner),this}leftJoin(e){return this.join(e,E.left),this}rightJoin(e){return this.join(e,E.right),this}}class De extends Me{constructor(){super(),this.selectFields=[],this.fieldsAsMap={}}formatFields(){const e=t.Type.array.safe(this.selectFields),r=t.Type.object.safe(this.fieldsAsMap),s=[];for(const i of e){if(!t.Type.string.isNotEmpty(i))continue;const e="*"!==i?this.safeKey(i):"*";if(t.Type.string.isNotEmpty(r[i])){const t=this.safeKey(r[i]);s.push(`${e} AS ${t}`)}else s.push(e)}return s}formatFieldStr(){let e,r=this.formatFields(),s=this.formatJoinFields(),i=this.formatFuncs();return fe(r)||fe(i)||fe(s)?(r=t.Type.array.safe(r),s=t.Type.array.safe(s),i=t.Type.array.safe(i),e=[].concat(r,s,i).join(", ")):e="*",e}formatTableStr(){const e=this.getQueryTables();return t.Type.string.isNotEmpty(e)?e:this.getQueryTable()}build(){const e=this.formatTableStr(),t=this.formatFieldStr();let r=`${u.select} ${t} FROM ${e}`;return r=this.whereBuild(r),r=this.groupBuild(r),r=this.havingBuild(r),r=this.orderBuild(r),r=this.limitBuild(r),r=this.joinBuild(r),r}fields(e,...r){const s=t.Type.array.safe(this.selectFields),n=i(e,r),o=[];for(const e of n)t.Type.object.isNotEmpty(e)?this.funcFeilds(e):t.Type.string.isNotEmpty(e)&&o.push(e);return this.selectFields=Array.from(new Set(s.concat(o))),this.selectFields.includes("*")&&(this.selectFields=["*"]),this}asMap(e){const r=t.Type.object.safe(this.fieldsAsMap);if(!de(e))throw new Error(n.errorFieldMap);return this.fieldsAsMap=Object.assign({},r,e),this}limit(e,t){return this.getLimitCase().limit(e,t),this}paging(e,t){return this.getLimitCase().paging(e,t),this}findOne(){return this.getLimitCase().step(1),this}}class Ke extends je{constructor(){super(),this.updateInfos={}}build(){const e=this.getQueryTable(),t=this.formatData().join(", ");let r=`${u.update} ${e} SET ${t}`;return r=this.whereBuild(r),r=this.orderBuild(r),r=this.limitBuild(r),r}formatData(){const e=this.updateInfos;if(!t.Type.object.isNotEmpty(e))throw new Error(n.emptyUpdateInfo);const r=[],s=Object.keys(e);for(const i of s){const s=e[i];if(!re(s))continue;const n=s.type,o=this.safeValue(s.value),a=this.safeKey(i);let u="";switch(n){case d.set:u=`${a} = ${o}`;break;case d.add:u=`${a} = ${a} + ${o}`;break;case d.minus:u=`${a} = ${a} - ${o}`}t.Type.string.isNotEmpty(u)&&r.push(u)}if(!fe(r))throw new Error(n.emptyUpdateInfo);return r}updateCache(e,r){if(!Te(e))throw new Error(n.errorFieldData);const s=t.Type.object.safe(this.updateInfos);for(const t of Object.keys(e)){const i={value:e[t],type:r};if(!re(i))throw new Error(n.errorUpdateInfo);s[t]=i}return this.updateInfos=s,this}set(e){return this.updateCache(e,d.set)}add(e){return this.updateCache(e,d.add)}minus(e){return this.updateCache(e,d.minus)}}class Ue extends je{build(){const e=this.getQueryTable();let t=`${u.delete} FROM ${e}`;return t=this.whereBuild(t),t=this.orderBuild(t),t=this.limitBuild(t),t}}class Ve extends Oe{constructor(){super(),this.queryType=u.replace}}class Re extends be{constructor(){super(),this.createTableSqlStr="",this.createDbName="",this.createTableInfo={}}checkDialect(){if(this._dialectType!==a.mysql)throw new Error(n.notSupportDialect)}info(e){return t.Type.string.isNotEmpty(e)?this.createTableSqlStr=e:ne(e,!0)&&(this.createTableInfo=e),this}dataBase(e){if(!t.Type.string.isNotEmpty(e))throw new Error(n.errorCreateDbName);return this.createDbName=e,this}build(){const e=this.createDbName;if(t.Type.string.isNotEmpty(e)){return s("CREATE DATABASE {{dbName}}",{dbName:e})}const r=this.createTableSqlStr;if(t.Type.string.isNotEmpty(r))return r;const i=this.createTableInfo;return ne(i,!0),this.tableTmpl(i)}tableTmpl(e){return s("CREATE TABLE IF NOT EXISTS {{tableName}}( {{feildsStr}}) {{tableOptionsStr}}",{tableName:e.tableName,feildsStr:this.feildsStr(e),tableOptionsStr:this.tableOptsStr(e)})+";"}feildsStr(e){const r=e.primaryKey,s=e.uniqueKey,i=e.fields,n=[];for(const e of i){const t=this.feildTmpl(e);n.push(t)}const o=this.primaryKeyStr(r),a=this.uniqueKeyStr(s);return t.Type.string.isNotEmpty(o)&&n.push(o),t.Type.string.isNotEmpty(a)&&n.push(a),n.join(",")}feildTmpl(e){const r=this.safeKey(e.field),i=e.type.toUpperCase(),n=e.notNull;let o=e.default;const a=e.autoIncrement,u=e.onUpdate;let h=e.comment;const c={field:r,type:i};if(!0===e.unsigned&&(c.unsigned=T.unsigned),!0===n&&(c.notNull=T.notNull),t.Type.string.is(o)||t.Type.number.is(o)){let e,r=!0;t.Type.string.is(o)&&(e=o.toUpperCase(),r=!Ce.includes(e)),o=r?this.safeValue(o):e,c.default=`${T.default} ${o}`}return!0===a&&(c.autoIncrement=T.autoIncrement),t.Type.string.isNotEmpty(u)&&(c.onUpdate=`${T.onUpdate} ${u}`),t.Type.string.isNotEmpty(h)&&(h=this.safeValue(h),c.comment=`${T.comment} ${h}`),s(Fe,c)}primaryKeyStr(e){let r="";const s=T.primaryKey;if(t.Type.string.isNotEmpty(e)){const t=this.safeKey(e);r=`${t} ${s} (${t})`}if(t.Type.object.is(e)){r=`${this.safeKey(e.keyName)} ${s} (${e.combineFields.map(e=>this.safeKey(e)).join(",")})`}return`${T.constraint} ${r}`}uniqueKeyStr(e){let r="";const s=T.uniqueKey;if(t.Type.string.isNotEmpty(e)){const t=this.safeKey(e);r=`${t} ${s} (${t})`}if(t.Type.object.is(e)){r=`${this.safeKey(e.keyName)} ${s} (${e.combineFields.map(e=>this.safeKey(e)).join(",")})`}return`${T.constraint} ${r}`}tableOptsStr(e){const r=e.engine,i=e.autoIncrement,n=e.defaultCharset,o=e.comment,a={};if(t.Type.string.isNotEmpty(r)){a.engine=`${T.engine}=${r}`}if(t.Type.number.is(i)){a.autoIncrement=`${T.autoIncrement}=${i}`}if(t.Type.string.isNotEmpty(n)){a.defaultCharset=`${T.defaultCharset}=${n}`}if(t.Type.string.isNotEmpty(o)){const e=T.comment,t=this.safeValue(o);a.comment=`${e}=${t}`}return s("{{engine}}{{autoIncrement}}{{defaultCharset}}{{comment}}",a)}}class _e extends be{constructor(){super(),this.alterInfos=[]}checkDialect(){if(this._dialectType!==a.mysql)throw new Error(n.notSupportDialect)}add(e,r={}){return t.Type.object.is(e)&&(e=(r=e).field||""),delete r.field,this.alterCache(w.add,e,r)}drop(e){return this.alterCache(w.drop,e,{})}modify(e,t){return delete t.field,this.alterCache(w.modify,e,t)}change(e,t){return this.alterCache(w.change,e,t)}alterCache(e,r,s){if(w.drop!==e&&!t.Type.object.isNotEmpty(s))throw new Error(n.errorAlterField);const i={method:e,field:r,alterField:s};if(!ae(i))throw new Error(n.errorAlterField);const o=t.Type.array.safe(this.alterInfos);return o.push(i),this.alterInfos=o,this}build(){const e=t.Type.array.safe(this.alterInfos),r=[];for(const t of e){if(!ae(t))continue;const e=s("{{method}}COLUMN {{field}}{{alterFieldStr}}",{method:t.method,field:this.safeKey(t.field),alterFieldStr:this.feildTmpl(t.alterField)});r.push(e)}if(!t.Type.array.isNotEmpty(r))throw new Error(n.emptyAlterInfos);const i=r.join(",");return s("ALTER TABLE {{queryTable}}{{alterInfosStr}}",{queryTable:this.getQueryTable(),alterInfosStr:i})}feildTmpl(e){const r=e.field,i=e.type,n=e.unsigned,o=e.notNull;let a=e.default;const u=e.autoIncrement,h=e.onUpdate;let c=e.comment;const l={};if(t.Type.string.isNotEmpty(r)&&(l.field=this.safeKey(r)),t.Type.string.isNotEmpty(i)&&(l.type=i.toUpperCase()),!0===n&&(l.unsigned=T.unsigned),!0===o&&(l.notNull=T.notNull),t.Type.string.is(a)||t.Type.number.is(a)){let e,r=!0;t.Type.string.is(a)&&(e=a.toUpperCase(),r=!Ce.includes(e)),a=r?this.safeValue(a):e,l.default=`${T.default} ${a}`}return!0===u&&(l.autoIncrement=T.autoIncrement),t.Type.string.isNotEmpty(h)&&(l.onUpdate=`${T.onUpdate} ${h}`),t.Type.string.isNotEmpty(c)&&(c=this.safeValue(c),l.comment=`${T.comment} ${c}`),s(Fe,l)}}const Pe={errorConnectConfig:"错误的连接配置",emptyConnectPool:"未连接数据库",errorDialectType:"错误的数据库类型",errorConnect:"错误的连接"},Ge=new r({type:Object,props:[{index:"host",required:!0,type:String,minLength:1},[{index:"port",type:String},{type:Number}],{index:"user",required:!0,type:String,minLength:1},{index:"password",type:String,minLength:1},{index:"database",required:!0,type:String,minLength:1},{index:"dialect",type:String,enum:a},{index:"connectionLimit",type:Number,natural:!0},{index:"connectTimeout",type:Number,natural:!0}]}).verify;class He{constructor(e){this.dbConfig={},this.setConfig(e)}setConfig(e){if(!Ge(e))throw new Error(Pe.errorConnectConfig);const r=e.host,s=e.user,i=e.password,n=e.port,o=e.database,a=e.connectTimeout;let u=e.connectionLimit;u=t.Type.number.isNatural(u)?u:1,this.dbConfig=t.Type.object.pure({host:r,user:s,password:i,port:n,database:o,connectTimeout:a,connectionLimit:u})}loadModule(e){try{return require(e)}catch(t){if(t&&"MODULE_NOT_FOUND"===t.code)throw new Error("请先安装模块 "+e);throw t}}}class Qe extends He{constructor(e){super(e),this.pool=this.getPool()}getPool(){let e=this.pool;const r=this.dbConfig;if(t.Type.object.is(e)&&t.Type.func.is(e.getConnection))return e;return e=this.loadModule(N.mysql).createPool(r),e}getDbConnect(){const e=this.getPool()||{};if(t.Type.func.isNot(e.getConnection))throw new Error(Pe.emptyConnectPool);return new Promise((r,s)=>{e.getConnection((e,i)=>{e&&s(e),(!i||t.Type.func.isNot(i.query)||t.Type.func.isNot(i.release))&&s(new Error(Pe.errorConnect)),r(i)})})}}class We extends He{constructor(e){super(e),this.pool=this.getPool()}getPool(){let e=this.pool;const r=this.dbConfig;if(t.Type.object.is(e)&&t.Type.func.is(e.acquire))return e;const s={server:r.host,port:r.port,user:r.user,password:r.password,database:r.database,connectionTimeout:r.connectTimeout,pool:{min:1,max:r.connectionLimit||1}};return e=new(this.loadModule(N.mssql).ConnectionPool)(s).connect(),e}getDbConnect(){let e=this.getPool()||{};return new Promise(async(t,r)=>{e=await e,this.pool=e;const s=e.request();t({query:(e,t)=>{s.query(e,(e,s)=>{e&&r(e),t(e,s)})},release:()=>{}})})}}class Ye{constructor(e){this.dialectType=e.dialect||a.mysql,this.connect=this.getConnect(e)}getConnect(e){let r;switch(this.dialectType){case a.mysql:r=new Qe(e);break;case a.mssql:r=new We(e)}if(t.Type.undefinedNull.is(r))throw new Error(Pe.errorDialectType);return r}async exec(e){const r=this.connect||{};if(t.Type.func.isNot(r.getDbConnect))throw new Error(Pe.emptyConnectPool);const s=await r.getDbConnect();return new Promise((t,r)=>{s.query(e,(e,i)=>{s.release(),e&&r(e),t(i)})})}}const Xe=[u.insert,u.replace,u.select,u.update,u.delete];class Je{constructor(e,t){this.queryTable="",this.dialectType=e||a.mysql,this.execute=t,this.queryStore=[]}insert(){return this.queryInstance(u.insert)}select(){return this.queryInstance(u.select)}update(){return this.queryInstance(u.update)}delete(){return this.queryInstance(u.delete)}replace(){return this.queryInstance(u.replace)}create(){return this.queryInstance(u.create)}alter(){return this.queryInstance(u.alter)}get func(){return this.widgetInstance(m.func)}get term(){return this.widgetInstance(m.term)}get order(){return this.widgetInstance(m.order)}queryInstance(e){let t;switch(e){case u.insert:t=new Oe;break;case u.replace:t=new Ve;break;case u.select:t=new De;break;case u.update:t=new Ke;break;case u.delete:t=new Ue;break;case u.create:t=new Re;break;case u.alter:t=new _e}return this.initInstance(e,t)}widgetInstance(e){let t;switch(e){case m.func:t=new ke;break;case m.term:t=new Ie;break;case m.order:t=new qe}return this.initInstance(e,t)}initInstance(e,r){r=t.Type.object.safe(r);const s=this.dialectType,i=this.execute,n=this.queryTable;return t.Type.string.isNotEmpty(n)&&t.Type.func.is(r.table)&&Xe.includes(e)&&r.table(n),t.Type.func.is(r.setDialect)&&r.setDialect(s),t.Type.func.is(r.checkDialect)&&r.checkDialect(),t.Type.func.is(r.setExecute)&&i&&r.setExecute(i),r}table(e){if(!t.Type.string.isNotEmpty(e))throw new Error(n.errorTableName);return this.queryTable=e,this}build(){throw new Error(n.emptyQueryType)}setConnect(e){if(t.Type.object.isNot(e))return this;e=t.Type.object.safe(e);const r=new Ye(e);return this.dialectType=e.dialect||a.mysql,this.execute=r,this}get query(){return this.build()}getStore(){return Ee.getStore()}storeSql(e){return Ee.storeSql(e)}isStoreEmpty(){return Ee.isStoreEmpty()}cleanStoreSql(){return Ee.cleanStoreSql()}}exports.Builder=Je,exports.Execute=Ye,exports.default=function(e){let r;if(t.Type.object.isNot(e))return r=a.mysql,t.Type.string.isNotEmpty(e)&&a[e]&&(r=e),new Je(r);r=e.dialect||a.mysql,e=t.Type.object.safe(e);const s=new Ye(e);return new Je(r,s)};
